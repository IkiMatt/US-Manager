<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USManager Web Application (IndexedDB Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f8fafc; /* slate-50 */
        }
        /* ... [Stili CSS invariati] ... */
        .us-node {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease;
            -webkit-user-select: none; /* Safari & iOS support */
            user-select: none; /* Prevent text selection during drag */
            z-index: 10; /* Ensure nodes are above lines */
            transform: translate(-50%, -50%);
        }
        .us-node:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .matrix-container {
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
          overflow: auto;
          cursor: grab;
          position: relative;
          touch-action: none;
          min-width: 250vw;
        }
        @media (min-width: 640px) {
            .matrix-container {
                min-width: auto;
                width: 100%;
            }
        }
        .matrix-container.grabbing {
            cursor: grabbing;
        }
        .matrix-content {
          position: absolute;
          left: 0;
          top: 0;
          transform-origin: 0 0;
          will-change: transform;
        }
        .modal-enter-active {
          opacity: 1;
          transform: scale(1);
          transition: opacity 200ms ease-out, transform 200ms ease-out;
        }
        .modal-exit {
          opacity: 1;
          transform: scale(1);
        }
        .modal-exit-active {
          opacity: 0;
          transform: scale(0.95);
          transition: opacity 200ms ease-in, transform 200ms ease-in;
        }
        .filter-content {
          max-height: 500px;
          overflow: hidden;
          transition: max-height 0.3s ease-in-out;
        }
        .filter-content.collapsed {
          max-height: 0;
        }
        .leaflet-container {
            z-index: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        console.log('Inizio caricamento script React con IndexedDB...');

        // MODIFICATO: Aggiunta tabella 'samples' e versione DB incrementata
        const db = new Dexie('USManagerDB');
        db.version(3).stores({
            projects: 'id, customProjectId', 
            usCards: 'id, projectId',
            diaryEntries: 'id, projectId',
            findsEntries: 'id, projectId',
            samples: 'id, projectId' // NUOVA TABELLA PER I CAMPIONI
        });
        console.log('Database Dexie configurato.');


        // Context for managing project data and app-wide state
        const AppContext = React.createContext();

        // Utility function to generate unique IDs
        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);

        // Utility for CSV export
        const exportToCsv = (filename, data) => {
          if (!data || data.length === 0) {
            alert('Nessun dato da esportare.');
            return;
          }

          let headers = Object.keys(data[0]);
          const headersToExclude = ['id', 'fullRelations', 'simplifiedRelations', 'photos', 'projectId', 'notes'];
          if (headers.includes('usNumber')) { // Caso Schede US
              headers = ['usNumber', ...headers.filter(h => !headersToExclude.includes(h))];
          } else if (headers.includes('sampleType')) { // Caso Campioni
              headers = ['identifier', 'sampleType', ...headers.filter(h => !headersToExclude.includes(h) && h !== 'identifier')];
          }
          else { // Altri casi
              headers = headers.filter(h => !headersToExclude.includes(h));
          }

          const csvRows = [];
          csvRows.push(headers.map(header => {
              return header.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
          }).join(','));

          for (const row of data) {
            const values = headers.map(header => {
              let value = row[header];
              if (typeof value === 'boolean') {
                  value = value ? 'S√¨' : 'No';
              }
              if (header === 'customFields' && typeof row.customFields === 'object') {
                  value = Object.entries(row.customFields).map(([k, v]) => `${k}: ${v}`).join('; ');
              }
              return (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"')))
                ? `"${value.replace(/"/g, '""')}"`
                : value;
            });
            csvRows.push(values.join(','));
          }

          const csvString = csvRows.join('\n');
          const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.setAttribute('download', filename);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };
        
        // --- INIZIO BLOCCO COMPONENTI REACT ---
        
        const Modal = ({ children, onClose, title, className = '', show }) => {
          const [visible, setVisible] = React.useState(false);

          React.useEffect(() => {
            if (show) {
              setVisible(true);
            } else {
              const timer = setTimeout(() => setVisible(false), 200);
              return () => clearTimeout(timer);
            }
          }, [show]);

          if (!visible && !show) return null;

          return (
            <div className={`fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity ${show ? 'opacity-100' : 'opacity-0'}`}>
              <div className={`bg-white rounded-lg shadow-2xl max-h-[90vh] overflow-y-auto transform transition-all ${className} ${show ? 'scale-100' : 'scale-95'}`}>
                <div className="flex justify-between items-center p-5 border-b border-slate-200">
                  <h2 className="text-xl font-semibold text-slate-800">{title}</h2>
                  <button onClick={onClose} className="text-slate-500 hover:text-slate-800 text-3xl font-bold">&times;</button>
                </div>
                <div className="p-5">
                  {children}
                </div>
              </div>
            </div>
          );
        };
        
        const PhotoViewerModal = ({ src, onClose }) => {
          if (!src) return null;

          return (
            <div 
              className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100] p-4"
              onClick={onClose}
            >
              <div className="relative max-w-4xl max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
                <img src={src} alt="Visualizzazione ingrandita" className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" />
                <button 
                  onClick={onClose} 
                  className="absolute -top-4 -right-4 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold shadow-lg hover:bg-slate-200 transition"
                >
                  &times;
                </button>
              </div>
            </div>
          );
        };

        const ConfirmDialog = ({ show, message, onConfirm, onCancel }) => {
          return (
            <Modal show={show} onClose={onCancel} title="Conferma Azione" className="w-full sm:max-w-md">
              <p className="text-slate-700 text-center mb-6">{message}</p>
              <div className="flex justify-center space-x-4">
                <button
                  onClick={onConfirm}
                  className="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition duration-200 shadow-md font-semibold active:scale-95"
                >
                  Conferma
                </button>
                <button
                  onClick={onCancel}
                  className="bg-slate-300 text-slate-800 py-2 px-6 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md font-semibold active:scale-95"
                >
                  Annulla
                </button>
              </div>
            </Modal>
          );
        };

        const ProjectDialog = ({ onClose, onSave, projectData = {} }) => {
          const [formData, setFormData] = React.useState({
            name: projectData.name || '',
            customProjectId: projectData.customProjectId || '',
            street: projectData.street || '',
            municipality: projectData.municipality || '',
            startYear: projectData.startYear || '',
            projectArchaeologist: projectData.projectArchaeologist || '',
            worksDirector: projectData.worksDirector || '',
            scientificManager: projectData.scientificManager || '',
            responsibleEntity: projectData.responsibleEntity || '',
            ministerialBody: projectData.ministerialBody || '',
          });

          const handleChange = (e) => {
            const { name, value } = e.target;
            if (name === 'startYear' && value !== '' && !/^\d{0,4}$/.test(value)) {
              return;
            }
            setFormData({ ...formData, [name]: value });
          };

          const handleSubmit = () => {
            if (Object.values(formData).some(val => val.trim() === '')) {
              alert('Compila tutti i campi.');
              return;
            }
            onSave(formData);
            onClose();
          };

          return (
            <Modal show={true} onClose={onClose} title="Dettagli Progetto" className="w-full sm:max-w-lg">
              <div className="grid grid-cols-1 gap-4">
                {Object.keys(formData).map(key => (
                    <div className="flex flex-col" key={key}>
                        <label className="text-sm font-medium text-slate-700 mb-1">{key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</label>
                        <input
                            type={key === 'startYear' ? 'number' : 'text'}
                            name={key}
                            value={formData[key]}
                            onChange={handleChange}
                            className="p-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder={`Inserisci ${key.replace(/([A-Z])/g, ' $1').toLowerCase()}`}
                        />
                    </div>
                ))}
                <button
                  onClick={handleSubmit}
                  className="mt-4 bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md active:scale-95"
                >
                  üíæ Salva Progetto
                </button>
              </div>
            </Modal>
          );
        };
const DiaryViewerDialog = ({ onClose }) => {
          const { currentProject, deleteDiaryEntry } = React.useContext(AppContext);
          const [showEditModal, setShowEditModal] = React.useState(false);
          const [selectedEntry, setSelectedEntry] = React.useState(null);
          const [showConfirmDelete, setShowConfirmDelete] = React.useState(false);
          const [entryToDelete, setEntryToDelete] = React.useState(null);

          const sortedEntries = Object.values(currentProject.diaryEntries || {}).sort((a, b) => {
            return b.date.localeCompare(a.date); // Ordina dal pi√π recente al pi√π vecchio
          });

          const handleNewEntry = () => {
            setSelectedEntry(null);
            setShowEditModal(true);
          };

          const handleEditEntry = (entry) => {
            setSelectedEntry(entry);
            setShowEditModal(true);
          };

          const handleDeleteClick = (entryId) => {
            setEntryToDelete(entryId);
            setShowConfirmDelete(true);
          };

          const confirmDelete = () => {
            deleteDiaryEntry(entryToDelete);
            setSelectedEntry(null);
            setShowConfirmDelete(false);
            setEntryToDelete(null);
          };
          
          const handleCloseEditModal = () => {
            setShowEditModal(false);
            setSelectedEntry(null);
          }

          return (
            <Modal show={true} onClose={onClose} title="Gestione Diario di Scavo" className="w-full sm:max-w-7xl">
              <div className="flex flex-col h-[75vh]">
                <div className="flex flex-wrap gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                  <button onClick={handleNewEntry} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md text-sm">Nuova Scheda Diario</button>
                  <button onClick={() => exportToCsv('diario.csv', Object.values(currentProject.diaryEntries || {}))} className="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 shadow-md text-sm">Esporta CSV</button>
                </div>

                <div className="overflow-x-auto flex-grow rounded-lg shadow-md border border-slate-200">
                  <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-100">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Data</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Giorno</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Operatori</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">US Indagate</th>
                        <th className="px-6 py-3 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Azioni</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                      {sortedEntries.length === 0 ? (
                        <tr>
                          <td colSpan="5" className="px-6 py-4 text-center text-slate-500">Nessuna scheda diario trovata.</td>
                        </tr>
                      ) : (
                        sortedEntries.map(entry => (
                          <tr key={entry.id} className="hover:bg-slate-50">
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{entry.date}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{entry.dayOfTheWeek}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800 truncate max-w-xs">{entry.operators}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{entry.suIndagate}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                              <div className="flex gap-2 justify-end">
                                <button onClick={() => handleEditEntry(entry)} className="text-indigo-600 hover:text-indigo-900 text-xl" title="Modifica">‚úèÔ∏è</button>
                                <button onClick={() => handleDeleteClick(entry.id)} className="text-red-600 hover:text-red-900 text-xl" title="Elimina">üóëÔ∏è</button>
                              </div>
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {showEditModal && (
                <DiaryEditDialog onClose={handleCloseEditModal} diaryEntry={selectedEntry} />
              )}
              <ConfirmDialog
                show={showConfirmDelete}
                message={`Sei sicuro di voler eliminare questa scheda diario?`}
                onConfirm={confirmDelete}
                onCancel={() => setShowConfirmDelete(false)}
              />
            </Modal>
          );
        };

        const FindsManagerDialog = ({ onClose }) => {
          const { currentProject, deleteFindEntry } = React.useContext(AppContext);
          const [showEditModal, setShowEditModal] = React.useState(false);
          const [selectedEntry, setSelectedEntry] = React.useState(null);
          const [showConfirmDelete, setShowConfirmDelete] = React.useState(false);
          const [entryToDelete, setEntryToDelete] = React.useState(null);

          const sortedEntries = Object.values(currentProject.findsEntries || {}).sort((a, b) => {
            return a.id.localeCompare(b.id);
          });

          const handleNewEntry = () => {
            setSelectedEntry(null);
            setShowEditModal(true);
          };

          const handleEditEntry = (entry) => {
            setSelectedEntry(entry);
            setShowEditModal(true);
          };

          const handleDeleteClick = (entryId) => {
            setEntryToDelete(entryId);
            setShowConfirmDelete(true);
          };

          const confirmDelete = () => {
            deleteFindEntry(entryToDelete);
            setSelectedEntry(null);
            setShowConfirmDelete(false);
            setEntryToDelete(null);
          };
          
          const handleCloseEditModal = () => {
            setShowEditModal(false);
            setSelectedEntry(null);
          }

          return (
            <Modal show={true} onClose={onClose} title="Gestione Reperti" className="w-full sm:max-w-7xl">
              <div className="flex flex-col h-[75vh]">
                <div className="flex flex-wrap gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                  <button onClick={handleNewEntry} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md text-sm">Nuova Scheda Reperto</button>
                  <button onClick={() => exportToCsv('reperti.csv', Object.values(currentProject.findsEntries || {}))} className="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 shadow-md text-sm">Esporta CSV</button>
                </div>

                <div className="overflow-x-auto flex-grow rounded-lg shadow-md border border-slate-200">
                  <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-100">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">ID Prog.</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Identificativo</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Data</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Tipo Reperto</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">US</th>
                        <th className="px-6 py-3 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Azioni</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                      {sortedEntries.length === 0 ? (
                        <tr>
                          <td colSpan="6" className="px-6 py-4 text-center text-slate-500">Nessun reperto trovato.</td>
                        </tr>
                      ) : (
                        sortedEntries.map(entry => (
                          <tr key={entry.id} className="hover:bg-slate-50">
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{entry.id}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-mono">{entry.identifier}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{entry.date}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{entry.findType}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{entry.us}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                              <div className="flex gap-2 justify-end">
                                <button onClick={() => handleEditEntry(entry)} className="text-indigo-600 hover:text-indigo-900 text-xl" title="Modifica">‚úèÔ∏è</button>
                                <button onClick={() => handleDeleteClick(entry.id)} className="text-red-600 hover:text-red-900 text-xl" title="Elimina">üóëÔ∏è</button>
                              </div>
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {showEditModal && (
                <FindsEditDialog onClose={handleCloseEditModal} findEntry={selectedEntry} />
              )}
              <ConfirmDialog
                show={showConfirmDelete}
                message={`Sei sicuro di voler eliminare questo reperto?`}
                onConfirm={confirmDelete}
                onCancel={() => setShowConfirmDelete(false)}
              />
            </Modal>
          );
        };
        const CustomFieldsDialog = ({ onClose }) => {
          const { currentProject, updateCustomFields } = React.useContext(AppContext);
          const [customFields, setCustomFields] = React.useState(currentProject.customFields || []);
          const [newFieldName, setNewFieldName] = React.useState('');
          const [newFieldType, setNewFieldType] = React.useState('');
          const [newFieldOptions, setNewFieldOptions] = React.useState('');
          const [showConfirm, setShowConfirm] = React.useState(false);
          const [fieldToDelete, setFieldToDelete] = React.useState(null);

          const addField = () => {
            if (!newFieldName.trim() || !newFieldType) {
              alert('Nome e tipo del campo sono obbligatori.');
              return;
            }
            if (customFields.some(f => f.name === newFieldName.trim())) {
              alert('Un campo con questo nome esiste gi√†.');
              return;
            }

            const newField = { name: newFieldName.trim(), type: newFieldType };
            if (newFieldType === 'Dropdown') {
              const options = newFieldOptions.split(',').map(opt => opt.trim()).filter(opt => opt !== '');
              if (options.length === 0) {
                alert('Le opzioni sono obbligatorie per il tipo Dropdown.');
                return;
              }
              newField.options = options;
            }

            const updatedFields = [...customFields, newField];
            setCustomFields(updatedFields);
            updateCustomFields(updatedFields);
            setNewFieldName('');
            setNewFieldType('');
            setNewFieldOptions('');
            alert(`Campo '${newFieldName}' aggiunto.`);
          };

          const handleDeleteClick = (fieldName) => {
            setFieldToDelete(fieldName);
            setShowConfirm(true);
          };

          const confirmDeleteField = () => {
            const updatedFields = customFields.filter(f => f.name !== fieldToDelete);
            setCustomFields(updatedFields);
            updateCustomFields(updatedFields);
            alert(`Campo '${fieldToDelete}' eliminato.`);
            setShowConfirm(false);
            setFieldToDelete(null);
          };

          return (
            <Modal show={true} onClose={onClose} title="Configura Campi Personalizzati" className="w-full sm:max-w-xl">
              <div className="space-y-6">
                <div className="p-4 border border-slate-200 rounded-lg shadow-sm bg-slate-50">
                  <h3 className="text-lg font-semibold mb-3 text-slate-800">Nuovo Campo Personalizzato</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">Nome Campo:</label>
                      <input
                        type="text"
                        value={newFieldName}
                        onChange={(e) => setNewFieldName(e.target.value)}
                        className="w-full p-2 border border-slate-300 rounded-md"
                        placeholder="Es. 'Stato di Conservazione'"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-1">Tipo:</label>
                      <select
                        value={newFieldType}
                        onChange={(e) => setNewFieldType(e.target.value)}
                        className="w-full p-2 border border-slate-300 rounded-md"
                      >
                        <option value="">Seleziona tipo</option>
                        <option value="Testo">Testo</option>
                        <option value="Numerico">Numerico</option>
                        <option value="Dropdown">Dropdown</option>
                        <option value="Checkbox">Checkbox</option>
                      </select>
                    </div>
                    {newFieldType === 'Dropdown' && (
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-slate-700 mb-1">Opzioni (separate da virgola):</label>
                        <input
                          type="text"
                          value={newFieldOptions}
                          onChange={(e) => setNewFieldOptions(e.target.value)}
                          className="w-full p-2 border border-slate-300 rounded-md"
                          placeholder="Es. 'Buono, Medio, Cattivo'"
                        />
                      </div>
                    )}
                  </div>
                  <button
                    onClick={addField}
                    className="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md active:scale-95"
                  >
                    Aggiungi Campo
                  </button>
                </div>

                <div className="p-4 border border-slate-200 rounded-lg shadow-sm">
                  <h3 className="text-lg font-semibold mb-3 text-slate-800">Campi Esistenti</h3>
                  {customFields.length === 0 ? (
                    <p className="text-slate-500">Nessun campo personalizzato configurato.</p>
                  ) : (
                    <ul className="divide-y divide-slate-200">
                      {customFields.map((field, index) => (
                        <li key={index} className="flex justify-between items-center py-3">
                          <span className="font-medium text-slate-800">{field.name} ({field.type})</span>
                          <button
                            onClick={() => handleDeleteClick(field.name)}
                            className="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200 active:scale-95"
                          >
                            Elimina
                          </button>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              </div>
              <ConfirmDialog
                show={showConfirm}
                message={`Sei sicuro di voler eliminare il campo '${fieldToDelete}'? Questa azione non elimina i dati gi√† salvati nelle schede esistenti, ma il campo non sar√† pi√π modificabile.`}
                onConfirm={confirmDeleteField}
                onCancel={() => setShowConfirm(false)}
              />
            </Modal>
          );
        };
        
        const USSelectionDialog = ({ onClose, onSelect, currentSelection = [], availableUS }) => {
          const [selectedUS, setSelectedUS] = React.useState(new Set(currentSelection));

          const toggleSelection = (usName) => {
            setSelectedUS(prev => {
              const newSet = new Set(prev);
              if (newSet.has(usName)) {
                newSet.delete(usName);
              } else {
                newSet.add(usName);
              }
              return newSet;
            });
          };

          const handleSave = () => {
            onSelect(Array.from(selectedUS));
            onClose();
          };

          return (
            <Modal show={true} onClose={onClose} title="Seleziona US" className="w-full sm:max-w-md">
              <div className="h-64 overflow-y-auto border border-slate-300 rounded-md p-2 mb-4">
                {availableUS.length === 0 ? (
                  <p className="p-2 text-slate-500">Nessuna US disponibile.</p>
                ) : (
                  availableUS.map((usName) => (
                    <div key={usName} className="flex items-center py-1 px-2 rounded-md hover:bg-slate-100">
                      <input
                        type="checkbox"
                        id={`us-${usName}`}
                        checked={selectedUS.has(usName)}
                        onChange={() => toggleSelection(usName)}
                        className="mr-3 h-4 w-4 rounded text-blue-600 focus:ring-blue-500"
                      />
                      <label htmlFor={`us-${usName}`} className="text-slate-800 cursor-pointer w-full">{usName}</label>
                    </div>
                  ))
                )}
              </div>
              <div className="flex justify-end space-x-2">
                 <button
                  onClick={onClose}
                  className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md active:scale-95"
                >
                  Annulla
                </button>
                <button
                  onClick={handleSave}
                  className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md active:scale-95"
                >
                  OK
                </button>
              </div>
            </Modal>
          );
        };

        const USCardDialog = ({ onClose, usCard = null, isViewer = false }) => {
          const { currentProject, updateUSCard, updateUSRelationsAutomatically } = React.useContext(AppContext);

          const getNextUSNumber = () => {
            const usNumbers = Object.values(currentProject.usCards || {}).map(card => card.usNumber);
            return usNumbers.length > 0 ? Math.max(...usNumbers) + 1 : 1;
          };

          const initialData = usCard || {
            id: generateUniqueId(),
            usNumber: getNextUSNumber(),
            type: '',
            negative: false,
            area: '',
            preliminaryArchaeologicalInvestigations: '',
            sector: '',
            square: '',
            latitude: '',
            longitude: '',
            distinctionCriteria: '',
            organicComponents: '',
            inorganicComponents: '',
            consistency: '',
            color: '',
            measures: '',
            fullRelations: {},
            simplifiedRelations: {},
            description: '',
            observations: '',
            interpretations: '',
            cronologicalContext: '',
            dating: '',
            datingElements: '',
            reportAuthor: '',
            date: new Date().toISOString().slice(0, 10).replace(/-/g, '_'),
            photos: [],
            customFields: {},
          };

          const [formData, setFormData] = React.useState(initialData);
          const [activeTab, setActiveTab] = React.useState('Dati Iniziali');
          const customFieldsConfig = currentProject.customFields || [];
          const [llmLoading, setLlmLoading] = React.useState({});
          const [gpsLoading, setGpsLoading] = React.useState(false);
          const [viewingPhoto, setViewingPhoto] = React.useState(null);

          const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            if (name === 'usNumber' && value !== '' && !/^\d*$/.test(value)) {
              return;
            }
            setFormData({ ...formData, [name]: type === 'checkbox' ? checked : value });
          };

          const handleTextareaChange = (name, value) => {
            setFormData({ ...formData, [name]: value });
          };
          
          const handleFullRelationChange = (fieldName, value) => {
              setFormData(prev => ({
                  ...prev,
                  fullRelations: {
                      ...prev.fullRelations,
                      [fieldName]: value,
                  },
              }));
          };

          const handleSimplifiedRelationChange = (key, value) => {
              const oldRelations = formData.simplifiedRelations[key] || '';
              const newRelations = value;

              setFormData(prev => ({
                  ...prev,
                  simplifiedRelations: {
                      ...prev.simplifiedRelations,
                      [key]: newRelations,
                  },
              }));

              updateUSRelationsAutomatically(formData.usNumber, key, oldRelations, newRelations);
          };

          const handleCustomFieldChange = (fieldName, value, type) => {
            let finalValue = value;
            if (type === 'Checkbox') {
              finalValue = value.target.checked;
            } else if (type === 'Numerico' && value !== '' && !/^\d*$/.test(value)) {
              return;
            }
            setFormData(prev => ({
              ...prev,
              customFields: {
                ...prev.customFields,
                [fieldName]: finalValue,
              },
            }));
          };

          const openUSSelectionDialog = (relationKey, currentValues) => {
            const availableUSNames = Object.keys(currentProject.usCards || {}).filter(
              (usId) => currentProject.usCards[usId].id !== formData.id
            ).map(usId => `US${currentProject.usCards[usId].usNumber}`);

            setShowUSSelection(true);
            setUSSelectionProps({
              currentSelection: currentValues.split(',').map(s => s.trim()).filter(s => s !== ''),
              availableUS: availableUSNames,
              onSelect: (selected) => {
                handleSimplifiedRelationChange(relationKey, selected.join(', '));
                setShowUSSelection(false);
              },
              onClose: () => setShowUSSelection(false),
            });
          };

          const handleSubmit = () => {
            if (!formData.usNumber || !formData.type) {
              alert('Il numero US e il tipo sono obbligatori.');
              return;
            }

            const isDuplicate = Object.values(currentProject.usCards || {}).some(
              (card) => card.usNumber === parseInt(formData.usNumber) && card.id !== formData.id
            );
            if (isDuplicate) {
              alert(`Una scheda US con il numero ${formData.usNumber} esiste gi√† in questo progetto.`);
              return;
            }

            const dataToSave = { ...formData, usNumber: parseInt(formData.usNumber, 10) };
            updateUSCard(dataToSave);
            onClose();
          };
          
          const handleGetCoordinates = () => {
            if (!navigator.geolocation) {
                alert('La geolocalizzazione non √® supportata da questo browser.');
                return;
            }
            setGpsLoading(true);
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    setFormData(prev => ({
                        ...prev,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                    }));
                    setGpsLoading(false);
                    alert('Coordinate GPS acquisite con successo!');
                },
                (error) => {
                    setGpsLoading(false);
                    alert(`Errore nell'acquisizione delle coordinate GPS: ${error.message}`);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
          };

          const usTypes = ["SU", "SU Muraria", "SU Rivestimento", "SU Documentaria", "SU Virtuale strutturale", "SU Virtuale non strutturale"];
          const consistencyOptions = Array.from({ length: 5 }, (_, i) => String(i + 1));
          const fullRelationFields = ["Copre (US separate da virgola)", "Coperto da (US separate da virgola)", "Uguale a (US separate da virgola)", "Si lega a (US separate da virgola)", "Si appoggia a (US separate da virgola)", "Taglia (US separate da virgola)", "Tagliato da (US separate da virgola)", "Riempie (US separate da virgola)", "Riempito da (US separate da virgola)"];
          const simplifiedRelationFields = [{ label: "Copre (US multiple)", key: "Copre" }, { label: "Coperto da (US multiple)", key: "Coperto da" }];

          const [showUSSelection, setShowUSSelection] = React.useState(false);
          const [usSelectionProps, setUSSelectionProps] = React.useState({});
          
          const handlePhotoUpload = (e) => {
              const files = Array.from(e.target.files);
              if (files.length === 0) return;
              if ((formData.photos || []).length + files.length > 4) {
                  alert(`Puoi caricare un massimo di 4 foto. Ne hai gi√† ${(formData.photos || []).length}.`);
                  return;
              }

              files.forEach(file => {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      setFormData(prev => ({
                          ...prev,
                          photos: [...(prev.photos || []), event.target.result]
                      }));
                  };
                  reader.readAsDataURL(file);
              });
              e.target.value = null;
          };

          const handleRemovePhoto = (indexToRemove) => {
              setFormData(prev => ({
                  ...prev,
                  photos: prev.photos.filter((_, index) => index !== indexToRemove)
              }));
          };

          const generateTextWithLLM = async (fieldName, currentText) => {
            setLlmLoading(prev => ({ ...prev, [fieldName]: true }));
            try {
              const prompt = `Genera un testo per il campo "${fieldName}" di una Scheda Unit√† Stratigrafica (US) archeologica.
              Il tipo di US √®: ${formData.type}.
              L'area √®: ${formData.area}.
              Il settore √®: ${formData.sector}.
              Il quadrato √®: ${formData.square}.
              I criteri di distinzione sono: ${formData.distinctionCriteria}.
              Le componenti organiche sono: ${formData.organicComponents}.
              Le componenti inorganiche sono: ${formData.inorganicComponents}.
              La consistenza √®: ${formData.consistency}.
              Il colore √®: ${formData.color}.
              Le misure sono: ${formData.measures}.
              Il contesto cronologico √®: ${formData.cronologicalContext}.
              La datazione √®: ${formData.dating}.
              Gli elementi di datazione sono: ${formData.datingElements}.
              L'autore della scheda √®: ${formData.reportAuthor}.
              La data della scheda √®: ${formData.date}.
              
              Testo attuale per il campo "${fieldName}" (se presente): ${currentText || 'Nessun testo attuale.'}
              
              Basandoti su queste informazioni, genera un testo dettagliato e professionale per il campo "${fieldName}". Se il testo attuale √® gi√† presente, espandilo o miglioralo. Se non √® presente, creane uno da zero.`;

              let chatHistory = [];
              chatHistory.push({ role: "user", parts: [{ text: prompt }] });
              const payload = { contents: chatHistory };
              const apiKey = "";
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
              
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
              const result = await response.json();

              if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                  const text = result.candidates[0].content.parts[0].text;
                  handleTextareaChange(fieldName, text);
              } else {
                  alert('Errore nella generazione del testo. Riprova pi√π tardi.');
                  console.error('LLM response error:', result);
              }
            } catch (error) {
              console.error('Error calling LLM:', error);
              alert('Si √® verificato un errore durante la comunicazione con l\'LLM.');
            } finally {
              setLlmLoading(prev => ({ ...prev, [fieldName]: false }));
            }
          };

          return (
            <>
            <PhotoViewerModal src={viewingPhoto} onClose={() => setViewingPhoto(null)} />
            <Modal show={true} onClose={onClose} title={usCard ? (isViewer ? "Visualizzazione Scheda US" : "Modifica Scheda US") : "Nuova Scheda US"} className="w-full sm:max-w-4xl">
              <div className="flex flex-wrap border-b border-slate-200">
                {['Dati Iniziali', 'Contenuto', 'Rapporti', 'Osservazioni', 'Autore', 'Foto', 'Campi Personalizzati'].map(tab => (
                  <button
                    key={tab}
                    className={`py-2 px-4 text-sm font-medium transition-colors ${activeTab === tab ? 'border-b-2 border-blue-600 text-blue-600' : 'text-slate-600 hover:text-slate-800'}`}
                    onClick={() => setActiveTab(tab)}
                  >
                    {tab}
                  </button>
                ))}
              </div>

              <div className="mt-4 p-4 bg-slate-50 rounded-lg shadow-inner">
                {activeTab === 'Dati Iniziali' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-slate-700">ID Interno:</label>
                      <span className="font-bold text-slate-900">{formData.id}</span>
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-slate-700">Nome Progetto:</label>
                      <span className="font-bold text-slate-900">{currentProject.name}</span>
                    </div>
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-slate-700">Codice Progetto:</label>
                      <span className="font-bold text-slate-900">{currentProject.customProjectId}</span>
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="usNumber" className="text-sm font-medium text-slate-700">Numero US:</label>
                      <input type="number" id="usNumber" name="usNumber" value={formData.usNumber} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="type" className="text-sm font-medium text-slate-700">Tipo:</label>
                      <select id="type" name="type" value={formData.type} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md">
                        <option value="">Seleziona</option>
                        {usTypes.map(type => <option key={type} value={type}>{type}</option>)}
                      </select>
                    </div>
                    <div className="flex items-center">
                      <input type="checkbox" id="negative" name="negative" checked={formData.negative} onChange={handleChange} disabled={isViewer} className="rounded text-blue-600 focus:ring-blue-500 mr-2 h-4 w-4" />
                      <label htmlFor="negative" className="text-sm font-medium text-slate-700">Negativa</label>
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="area" className="text-sm font-medium text-slate-700">Area:</label>
                      <input type="text" id="area" name="area" value={formData.area} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="preliminaryArchaeologicalInvestigations" className="text-sm font-medium text-slate-700">Indagini archeologiche preliminari:</label>
                      <input type="text" id="preliminaryArchaeologicalInvestigations" name="preliminaryArchaeologicalInvestigations" value={formData.preliminaryArchaeologicalInvestigations} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="sector" className="text-sm font-medium text-slate-700">Settore:</label>
                      <input type="text" id="sector" name="sector" value={formData.sector} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="square" className="text-sm font-medium text-slate-700">Quadrato:</label>
                      <input type="text" id="square" name="square" value={formData.square} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                        <label htmlFor="latitude" className="text-sm font-medium text-slate-700">Latitudine:</label>
                        <input type="text" id="latitude" name="latitude" value={formData.latitude} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" placeholder="Es. 41.9028" />
                    </div>
                    <div className="flex flex-col">
                        <label htmlFor="longitude" className="text-sm font-medium text-slate-700">Longitudine:</label>
                        <input type="text" id="longitude" name="longitude" value={formData.longitude} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" placeholder="Es. 12.4964" />
                    </div>
                    {!isViewer && (
                        <div className="flex flex-col justify-end">
                            <button
                                onClick={handleGetCoordinates}
                                disabled={gpsLoading}
                                className="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition duration-200 shadow-md flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-wait"
                            >
                                {gpsLoading ? 'Acquisizione...' : 'üìç Ottieni GPS'}
                            </button>
                        </div>
                    )}
                  </div>
                )}

                {activeTab === 'Contenuto' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="flex flex-col">
                      <label htmlFor="distinctionCriteria" className="text-sm font-medium text-slate-700">Criteri di distinzione:</label>
                      <input type="text" id="distinctionCriteria" name="distinctionCriteria" value={formData.distinctionCriteria} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="organicComponents" className="text-sm font-medium text-slate-700">Componenti organiche:</label>
                      <input type="text" id="organicComponents" name="organicComponents" value={formData.organicComponents} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="inorganicComponents" className="text-sm font-medium text-slate-700">Componenti inorganiche:</label>
                      <input type="text" id="inorganicComponents" name="inorganicComponents" value={formData.inorganicComponents} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="consistency" className="text-sm font-medium text-slate-700">Consistenza:</label>
                      <select id="consistency" name="consistency" value={formData.consistency} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md">
                        <option value="">Seleziona</option>
                        {consistencyOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                      </select>
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="color" className="text-sm font-medium text-slate-700">Colore:</label>
                      <input type="text" id="color" name="color" value={formData.color} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="measures" className="text-sm font-medium text-slate-700">Misure:</label>
                      <input type="text" id="measures" name="measures" value={formData.measures} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                  </div>
                )}

                {activeTab === 'Rapporti' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="p-4 border border-slate-200 rounded-lg shadow-sm bg-white">
                      <h3 className="text-lg font-semibold mb-3 text-slate-800">Rapporti Completi</h3>
                      {fullRelationFields.map(field => (
                        <div key={field} className="flex flex-col mb-2">
                          <label className="text-sm font-medium text-slate-700 mb-1">{field}:</label>
                          <input
                            type="text"
                            value={formData.fullRelations[field] || ''}
                            onChange={(e) => handleFullRelationChange(field, e.target.value)}
                            disabled={isViewer}
                            className="p-2 border border-slate-300 rounded-md"
                          />
                        </div>
                      ))}
                    </div>
                    <div className="p-4 border border-slate-200 rounded-lg shadow-sm bg-white">
                      <h3 className="text-lg font-semibold mb-3 text-slate-800">Rapporti Semplificati</h3>
                      {simplifiedRelationFields.map(field => (
                        <div key={field.key} className="flex flex-col mb-2">
                          <label className="text-sm font-medium text-slate-700 mb-1">{field.label}:</label>
                          <div className="flex items-center">
                            <input
                              type="text"
                              value={formData.simplifiedRelations[field.key] || ''}
                              onChange={(e) => handleSimplifiedRelationChange(field.key, e.target.value)}
                              disabled={isViewer}
                              className="flex-grow p-2 border border-slate-300 rounded-md"
                            />
                            {!isViewer && (
                              <button
                                onClick={() => openUSSelectionDialog(field.key, formData.simplifiedRelations[field.key] || '')}
                                className="ml-2 bg-slate-200 text-slate-700 px-3 py-2 rounded-md hover:bg-slate-300 transition duration-200"
                              >
                                ...
                              </button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {activeTab === 'Osservazioni' && (
                  <div className="grid grid-cols-1 gap-4">
                    <div className="flex flex-col">
                      <label htmlFor="description" className="text-sm font-medium text-slate-700">Descrizione:</label>
                      <textarea id="description" name="description" value={formData.description} onChange={(e) => handleTextareaChange('description', e.target.value)} disabled={isViewer} rows="3" className="p-2 border border-slate-300 rounded-md"></textarea>
                      {!isViewer && (
                        <button
                          onClick={() => generateTextWithLLM('description', formData.description)}
                          disabled={llmLoading.description}
                          className="mt-2 w-full sm:w-auto bg-purple-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-purple-700 transition duration-200 shadow-sm text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {llmLoading.description ? 'Generazione...' : '‚ú® Suggerisci Descrizione'}
                        </button>
                      )}
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="observations" className="text-sm font-medium text-slate-700">Osservazioni:</label>
                      <textarea id="observations" name="observations" value={formData.observations} onChange={(e) => handleTextareaChange('observations', e.target.value)} disabled={isViewer} rows="3" className="p-2 border border-slate-300 rounded-md"></textarea>
                      {!isViewer && (
                        <button
                          onClick={() => generateTextWithLLM('observations', formData.observations)}
                          disabled={llmLoading.observations}
                          className="mt-2 w-full sm:w-auto bg-purple-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-purple-700 transition duration-200 shadow-sm text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {llmLoading.observations ? 'Generazione...' : '‚ú® Suggerisci Osservazioni'}
                        </button>
                      )}
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="interpretations" className="text-sm font-medium text-slate-700">Interpretazioni:</label>
                      <textarea id="interpretations" name="interpretations" value={formData.interpretations} onChange={(e) => handleTextareaChange('interpretations', e.target.value)} disabled={isViewer} rows="3" className="p-2 border border-slate-300 rounded-md"></textarea>
                      {!isViewer && (
                        <button
                          onClick={() => generateTextWithLLM('interpretations', formData.interpretations)}
                          disabled={llmLoading.interpretations}
                          className="mt-2 w-full sm:w-auto bg-purple-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-purple-700 transition duration-200 shadow-sm text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {llmLoading.interpretations ? 'Generazione...' : '‚ú® Suggerisci Interpretazioni'}
                        </button>
                      )}
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="cronologicalContext" className="text-sm font-medium text-slate-700">Contesto cronologico:</label>
                      <input type="text" id="cronologicalContext" name="cronologicalContext" value={formData.cronologicalContext} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="dating" className="text-sm font-medium text-slate-700">Datazione:</label>
                      <input type="text" id="dating" name="dating" value={formData.dating} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="datingElements" className="text-sm font-medium text-slate-700">Elementi di datazione:</label>
                      <textarea id="datingElements" name="datingElements" value={formData.datingElements} onChange={(e) => handleTextareaChange('datingElements', e.target.value)} disabled={isViewer} rows="3" className="p-2 border border-slate-300 rounded-md"></textarea>
                    </div>
                  </div>
                )}

                {activeTab === 'Autore' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="flex flex-col">
                      <label className="text-sm font-medium text-slate-700">Responsabile scientifico:</label>
                      <span className="font-bold text-slate-900">{currentProject.scientificManager}</span>
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="reportAuthor" className="text-sm font-medium text-slate-700">Autore scheda:</label>
                      <input type="text" id="reportAuthor" name="reportAuthor" value={formData.reportAuthor} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                    <div className="flex flex-col">
                      <label htmlFor="date" className="text-sm font-medium text-slate-700">Data (YYYY_MM_DD):</label>
                      <input type="text" id="date" name="date" value={formData.date} onChange={handleChange} disabled={isViewer} className="p-2 border border-slate-300 rounded-md" />
                    </div>
                  </div>
                )}

                {activeTab === 'Foto' && (
                  <div className="grid grid-cols-1 gap-4">
                    <div>
                        <label className="text-sm font-medium text-slate-700 mb-2 block">Foto (max 4):</label>
                        <input
                            type="file"
                            id="photoUpload"
                            multiple
                            accept="image/*"
                            onChange={handlePhotoUpload}
                            disabled={isViewer || (formData.photos || []).length >= 4}
                            className="hidden"
                        />
                        {!isViewer && (
                            <button
                                onClick={() => document.getElementById('photoUpload').click()}
                                disabled={(formData.photos || []).length >= 4}
                                className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed active:scale-95"
                            >
                                Aggiungi Foto dal PC
                            </button>
                        )}
                        {(formData.photos || []).length >= 4 && (
                            <p className="text-sm text-red-500 mt-2">Limite massimo di 4 foto raggiunto.</p>
                        )}
                    </div>
                    <div className="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {(formData.photos || []).map((photoSrc, index) => (
                            <div key={index} className="relative group cursor-pointer" onClick={() => setViewingPhoto(photoSrc)}>
                                <img
                                    src={photoSrc}
                                    alt={`Anteprima ${index + 1}`}
                                    className="w-full h-auto object-cover rounded-md shadow-md aspect-square"
                                />
                                {!isViewer && (
                                    <button
                                        onClick={(e) => { e.stopPropagation(); handleRemovePhoto(index); }}
                                        className="absolute top-1 right-1 bg-red-600 text-white rounded-full p-0 w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                        title="Rimuovi foto"
                                    >
                                        &times;
                                    </button>
                                )}
                                 <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center">
                                    <p className="text-white text-lg font-bold opacity-0 group-hover:opacity-100">üëÅÔ∏è</p>
                                </div>
                            </div>
                        ))}
                    </div>
                  </div>
                )}

                {activeTab === 'Campi Personalizzati' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {customFieldsConfig.length === 0 ? (
                      <p className="md:col-span-2 text-slate-500">Nessun campo personalizzato configurato per questo progetto.</p>
                    ) : (
                      customFieldsConfig.map((field) => (
                        <div key={field.name} className="flex flex-col">
                          <label className="text-sm font-medium text-slate-700 mb-1">{field.name}:</label>
                          {field.type === 'Testo' && (
                            <input
                              type="text"
                              value={formData.customFields[field.name] || ''}
                              onChange={(e) => handleCustomFieldChange(field.name, e.target.value, field.type)}
                              disabled={isViewer}
                              className="p-2 border border-slate-300 rounded-md"
                            />
                          )}
                          {field.type === 'Numerico' && (
                            <input
                              type="number"
                              value={formData.customFields[field.name] || ''}
                              onChange={(e) => handleCustomFieldChange(field.name, e.target.value, field.type)}
                              disabled={isViewer}
                              className="p-2 border border-slate-300 rounded-md"
                            />
                          )}
                          {field.type === 'Dropdown' && (
                            <select
                              value={formData.customFields[field.name] || ''}
                              onChange={(e) => handleCustomFieldChange(field.name, e.target.value, field.type)}
                              disabled={isViewer}
                              className="p-2 border border-slate-300 rounded-md"
                            >
                              <option value="">Seleziona</option>
                              {field.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                          )}
                          {field.type === 'Checkbox' && (
                            <input
                              type="checkbox"
                              checked={formData.customFields[field.name] || false}
                              onChange={(e) => handleCustomFieldChange(field.name, e, field.type)}
                              disabled={isViewer}
                              className="rounded text-blue-600 focus:ring-blue-500 mt-2 h-4 w-4"
                            />
                          )}
                        </div>
                      ))
                    )}
                  </div>
                )}
              </div>

              {!isViewer && (
                <div className="mt-6 flex justify-end space-x-2">
                  <button
                    onClick={onClose}
                    className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md active:scale-95"
                  >
                    Annulla
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md active:scale-95"
                  >
                    üíæ Salva Scheda
                  </button>
                </div>
              )}

              {showUSSelection && (
                <USSelectionDialog show={showUSSelection} {...usSelectionProps} />
              )}
            </Modal>
            </>
          );
        };

        const DiaryEditDialog = ({ onClose, diaryEntry = null }) => {
          const { currentProject, updateDiaryEntry } = React.useContext(AppContext);

          const initialData = diaryEntry || {
            id: generateUniqueId(),
            date: new Date().toISOString().slice(0, 10).replace(/-/g, '_'),
            dayOfTheWeek: '',
            operators: '',
            workAddress: '',
            latitude: '',
            longitude: '',
            suIndagate: '',
            description: '',
            archaeologicalFinds: false,
            llmSummary: '',
            photos: [],
          };

          const [formData, setFormData] = React.useState(initialData);
          const [showUSSelection, setShowUSSelection] = React.useState(false);
          const [usSelectionProps, setUSSelectionProps] = React.useState({});
          const [llmLoading, setLlmLoading] = React.useState(false);
          const [gpsLoading, setGpsLoading] = React.useState(false);
          const [viewingPhoto, setViewingPhoto] = React.useState(null);

          const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            setFormData({ ...formData, [name]: type === 'checkbox' ? checked : value });
          };

          const handleTextareaChange = (name, value) => {
            setFormData({ ...formData, [name]: value });
          };

          const validateDate = (dateStr) => {
            return /^\d{4}_\d{2}_\d{2}$/.test(dateStr);
          };

          const openUSSelectionForDiary = () => {
            const availableUSNames = Object.keys(currentProject.usCards || {}).map(usId => `US${currentProject.usCards[usId].usNumber}`);
            setShowUSSelection(true);
            setUSSelectionProps({
              currentSelection: formData.suIndagate.split(',').map(s => s.trim()).filter(s => s !== ''),
              availableUS: availableUSNames,
              onSelect: (selected) => {
                setFormData(prev => ({ ...prev, suIndagate: selected.join(', ') }));
                setShowUSSelection(false);
              },
              onClose: () => setShowUSSelection(false),
            });
          };

          const handleGetCoordinates = () => {
            if (!navigator.geolocation) {
                alert('La geolocalizzazione non √® supportata da questo browser.');
                return;
            }
            setGpsLoading(true);
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    setFormData(prev => ({
                        ...prev,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                    }));
                    setGpsLoading(false);
                    alert('Coordinate GPS acquisite con successo!');
                },
                (error) => {
                    setGpsLoading(false);
                    alert(`Errore nell'acquisizione delle coordinate GPS: ${error.message}`);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
          };

          const handleSubmit = () => {
            if (!validateDate(formData.date)) {
              alert('La data deve essere in formato YYYY_MM_DD (es. 2025_07_08).');
              return;
            }
            updateDiaryEntry(formData);
            onClose();
          };

          const handlePhotoUpload = (e) => {
              const files = Array.from(e.target.files);
              if (files.length === 0) return;
              if ((formData.photos || []).length + files.length > 4) {
                  alert(`Puoi caricare un massimo di 4 foto. Ne hai gi√† ${(formData.photos || []).length}.`);
                  return;
              }

              files.forEach(file => {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      setFormData(prev => ({
                          ...prev,
                          photos: [...(prev.photos || []), event.target.result]
                      }));
                  };
                  reader.readAsDataURL(file);
              });
              e.target.value = null;
          };

          const handleRemovePhoto = (indexToRemove) => {
              setFormData(prev => ({
                  ...prev,
                  photos: prev.photos.filter((_, index) => index !== indexToRemove)
              }));
          };

          const daysOfWeek = ["Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨", "Sabato", "Domenica"];

          const generateDiarySummary = async () => {
            setLlmLoading(true);
            try {
              const prompt = `Genera un breve riassunto del lavoro giornaliero basandoti sui seguenti dettagli del diario archeologico:
              Data: ${formData.date} (${formData.dayOfTheWeek})
              Operatori: ${formData.operators || 'N/D'}
              US indagate: ${formData.suIndagate || 'Nessuna'}
              Descrizione dettagliata del lavoro: ${formData.description || 'Nessuna descrizione fornita.'}
              Rinvenimenti Archeologici: ${formData.archaeologicalFinds ? 'S√¨' : 'No'}.
              
              Il riassunto dovrebbe essere conciso e mettere in evidenza le attivit√† principali e i risultati.`;

              let chatHistory = [];
              chatHistory.push({ role: "user", parts: [{ text: prompt }] });
              const payload = { contents: chatHistory };
              const apiKey = "";
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
              
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
              const result = await response.json();

              if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                  const text = result.candidates[0].content.parts[0].text;
                  setFormData(prev => ({ ...prev, llmSummary: text }));
              } else {
                  alert('Errore nella generazione del riassunto. Riprova pi√π tardi.');
                  console.error('LLM response error:', result);
              }
            } catch (error) {
              console.error('Error calling LLM:', error);
              alert('Si √® verificato un errore durante la comunicazione con l\'LLM.');
            } finally {
              setLlmLoading(false);
            }
          };

          return (
            <>
            <PhotoViewerModal src={viewingPhoto} onClose={() => setViewingPhoto(null)} />
            <Modal show={true} onClose={onClose} title={diaryEntry ? "Modifica Scheda Diario" : "Nuova Scheda Diario"} className="w-full sm:max-w-2xl">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex flex-col">
                  <label htmlFor="date" className="text-sm font-medium text-slate-700">Data (YYYY_MM_DD):</label>
                  <input type="text" id="date" name="date" value={formData.date} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                <div className="flex flex-col">
                  <label htmlFor="dayOfTheWeek" className="text-sm font-medium text-slate-700">Giorno della settimana:</label>
                  <select id="dayOfTheWeek" name="dayOfTheWeek" value={formData.dayOfTheWeek} onChange={handleChange} className="p-2 border border-slate-300 rounded-md">
                    <option value="">Seleziona</option>
                    {daysOfWeek.map(day => <option key={day} value={day}>{day}</option>)}
                  </select>
                </div>
                <div className="flex flex-col md:col-span-2">
                  <label htmlFor="operators" className="text-sm font-medium text-slate-700">Operatori:</label>
                  <input type="text" id="operators" name="operators" value={formData.operators} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                <div className="flex flex-col md:col-span-2">
                  <label htmlFor="workAddress" className="text-sm font-medium text-slate-700">Indirizzo dei lavori in giornata:</label>
                  <input type="text" id="workAddress" name="workAddress" value={formData.workAddress} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>

                <div className="flex flex-col">
                    <label htmlFor="latitude" className="text-sm font-medium text-slate-700">Latitudine:</label>
                    <input type="text" id="latitude" name="latitude" value={formData.latitude} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" placeholder="Es. 41.9028" />
                </div>
                <div className="flex flex-col">
                    <label htmlFor="longitude" className="text-sm font-medium text-slate-700">Longitudine:</label>
                    <input type="text" id="longitude" name="longitude" value={formData.longitude} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" placeholder="Es. 12.4964" />
                </div>
                <div className="md:col-span-2">
                    <button
                        onClick={handleGetCoordinates}
                        disabled={gpsLoading}
                        className="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition duration-200 shadow-md flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-wait"
                    >
                        {gpsLoading ? 'Acquisizione...' : 'üìç Ottieni GPS'}
                    </button>
                </div>
                
                <div className="flex flex-col md:col-span-2">
                  <label htmlFor="suIndagate" className="text-sm font-medium text-slate-700">US indagate:</label>
                  <div className="flex items-center">
                    <input type="text" id="suIndagate" name="suIndagate" value={formData.suIndagate} onChange={handleChange} className="flex-grow p-2 border border-slate-300 rounded-md" />
                    <button onClick={openUSSelectionForDiary} className="ml-2 bg-slate-200 text-slate-700 px-3 py-2 rounded-md hover:bg-slate-300 transition duration-200">...</button>
                  </div>
                </div>
                <div className="flex flex-col md:col-span-2">
                  <label htmlFor="description" className="text-sm font-medium text-slate-700">Descrizione:</label>
                  <textarea id="description" name="description" value={formData.description} onChange={(e) => handleTextareaChange('description', e.target.value)} rows="4" className="p-2 border border-slate-300 rounded-md"></textarea>
                </div>
                <div className="flex items-center md:col-span-2">
                  <input type="checkbox" id="archaeologicalFinds" name="archaeologicalFinds" checked={formData.archaeologicalFinds} onChange={handleChange} className="rounded text-blue-600 focus:ring-blue-500 mr-2 h-4 w-4" />
                  <label htmlFor="archaeologicalFinds" className="text-sm font-medium text-slate-700">Rinvenimenti archeologici</label>
                </div>
                <div className="flex flex-col md:col-span-2">
                    <label className="text-sm font-medium text-slate-700 mb-2 block">Foto (max 4):</label>
                    <input
                        type="file"
                        id="diaryPhotoUpload"
                        multiple
                        accept="image/*"
                        onChange={handlePhotoUpload}
                        disabled={(formData.photos || []).length >= 4}
                        className="hidden"
                    />
                    <button
                        onClick={() => document.getElementById('diaryPhotoUpload').click()}
                        disabled={(formData.photos || []).length >= 4}
                        className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Aggiungi Foto dal PC
                    </button>
                    {(formData.photos || []).length >= 4 && (
                        <p className="text-sm text-red-500 mt-2">Limite massimo di 4 foto raggiunto.</p>
                    )}
                    <div className="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {(formData.photos || []).map((photoSrc, index) => (
                            <div key={index} className="relative group cursor-pointer" onClick={() => setViewingPhoto(photoSrc)}>
                                <img
                                    src={photoSrc}
                                    alt={`Anteprima ${index + 1}`}
                                    className="w-full h-auto object-cover rounded-md shadow-md aspect-square"
                                />
                                <button
                                    onClick={(e) => { e.stopPropagation(); handleRemovePhoto(index); }}
                                    className="absolute top-1 right-1 bg-red-600 text-white rounded-full p-0 w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                    title="Rimuovi foto"
                                >
                                    &times;
                                </button>
                                <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center">
                                    <p className="text-white text-lg font-bold opacity-0 group-hover:opacity-100">üëÅÔ∏è</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
                <div className="flex flex-col md:col-span-2">
                  <button
                    onClick={generateDiarySummary}
                    disabled={llmLoading}
                    className="mt-2 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {llmLoading ? 'Generazione Riepilogo...' : '‚ú® Riepiloga Lavoro Giornaliero'}
                  </button>
                  {formData.llmSummary && (
                    <div className="mt-4 p-3 bg-slate-100 rounded-md border border-slate-300">
                      <h4 className="text-sm font-semibold text-slate-700 mb-1">Riepilogo Generato:</h4>
                      <p className="text-sm text-slate-800 whitespace-pre-wrap">{formData.llmSummary}</p>
                    </div>
                  )}
                </div>
              </div>
              <div className="mt-6 flex justify-end space-x-2">
                 <button
                    onClick={onClose}
                    className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md"
                  >
                    Annulla
                  </button>
                <button
                  onClick={handleSubmit}
                  className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md"
                >
                  üíæ Salva Diario
                </button>
              </div>
              {showUSSelection && (
                <USSelectionDialog show={showUSSelection} {...usSelectionProps} />
              )}
            </Modal>
            </>
          );
        };

        const FindsEditDialog = ({ onClose, findEntry = null }) => {
          const { currentProject, updateFindEntry } = React.useContext(AppContext);

          const getNextFindId = () => {
            const findIds = Object.values(currentProject.findsEntries || {}).map(entry => parseInt(entry.id, 10)).filter(id => !isNaN(id));
            const nextIdNum = findIds.length > 0 ? Math.max(...findIds) + 1 : 1;
            return String(nextIdNum).padStart(4, '0');
          };

          const initialData = findEntry || {
            id: getNextFindId(),
            type: '',
            date: new Date().toISOString().slice(0, 10).replace(/-/g, ''),
            findType: '',
            nrReperti: '',
            areaName: '',
            square: '',
            quadrant: '',
            us: '',
            description: '',
          };

          const [formData, setFormData] = React.useState(initialData);
          const [identifier, setIdentifier] = React.useState('');
          const [llmLoading, setLlmLoading] = React.useState(false);

          React.useEffect(() => {
            const projCustomId = currentProject.customProjectId || 'N_A';
            const findId = formData.id;
            const date = formData.date;
            const findType = formData.findType.replace(/ /g, '-');
            setIdentifier(findId && projCustomId && date && findType ? `${findId}_${projCustomId}_${date}_${findType}` : '...');
          }, [formData.id, formData.date, formData.findType, currentProject.customProjectId]);

          const handleChange = (e) => {
            const { name, value } = e.target;
            if ((name === 'date' || name === 'nrReperti') && value !== '' && !/^\d*$/.test(value)) {
              return;
            }
            setFormData({ ...formData, [name]: value });
          };

          const handleTextareaChange = (name, value) => {
            setFormData({ ...formData, [name]: value });
          };

          const handleSubmit = () => {
            if (!formData.type || !formData.date || !formData.findType) {
              alert("I campi 'Tipo', 'Data' e 'Tipologia Reperto' sono obbligatori.");
              return;
            }

            if (!findEntry) {
              const isDuplicate = Object.values(currentProject.findsEntries || {}).some(
                (entry) => entry.id === formData.id
              );
              if (isDuplicate) {
                alert(`Un reperto con ID ${formData.id} esiste gi√†.`);
                return;
              }
            }

            updateFindEntry({ ...formData, identifier });
            onClose();
          };

          const findTypes = ["ceramica", "concotto", "industria litica", "metallo", "ossa umane", "resti faunistici", "resti botanici", "carbone", "intonaco", "altro"];
          const usOptions = Object.keys(currentProject.usCards || {}).map(usId => `US${currentProject.usCards[usId].usNumber}`);

          const generateFindDescription = async () => {
            setLlmLoading(true);
            try {
              const prompt = `Genera una descrizione dettagliata per un reperto archeologico basandoti sulle seguenti informazioni:
              ID Reperto: ${formData.id}
              Tipo di reperto: ${formData.type}
              Data di ritrovamento: ${formData.date}
              Tipologia specifica del reperto: ${formData.findType}
              Numero di reperti: ${formData.nrReperti || 'non specificato'}
              Nome area: ${formData.areaName || 'non specificato'}
              Quadrato: ${formData.square || 'non specificato'}
              Quadrante: ${formData.quadrant || 'non specificato'}
              US di riferimento: ${formData.us || 'non specificata'}
              
              Testo attuale della descrizione (se presente): ${formData.description || 'Nessun testo attuale.'}
              
              Basandoti su queste informazioni, genera una descrizione archeologica dettagliata e professionale per il reperto. Se il testo attuale √® gi√† presente, espandilo o miglioralo. Se non √® presente, creane uno da zero.`;

              let chatHistory = [];
              chatHistory.push({ role: "user", parts: [{ text: prompt }] });
              const payload = { contents: chatHistory };
              const apiKey = "";
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
              
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
              const result = await response.json();

              if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                  const text = result.candidates[0].content.parts[0].text;
                  handleTextareaChange('description', text);
              } else {
                  alert('Errore nella generazione della descrizione. Riprova pi√π tardi.');
                  console.error('LLM response error:', result);
              }
            } catch (error) {
              console.error('Error calling LLM:', error);
              alert('Si √® verificato un errore durante la comunicazione con l\'LLM.');
            } finally {
              setLlmLoading(false);
            }
          };

          return (
            <Modal show={true} onClose={onClose} title={findEntry ? "Modifica Scheda Reperto" : "Nuova Scheda Reperto"} className="w-full sm:max-w-2xl">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex flex-col">
                  <label className="text-sm font-medium text-slate-700">ID Progressivo:</label>
                  <span className="font-bold text-slate-900">{formData.id}</span>
                </div>
                <div className="flex flex-col">
                  <label className="text-sm font-medium text-slate-700">Nome Progetto:</label>
                  <span className="font-bold text-slate-900">{currentProject.name}</span>
                </div>
                <div className="flex flex-col">
                  <label className="text-sm font-medium text-slate-700">Codice Progetto:</label>
                  <span className="font-bold text-slate-900">{currentProject.customProjectId}</span>
                </div>
                <div className="flex flex-col">
                  <label htmlFor="type" className="text-sm font-medium text-slate-700">Tipo:</label>
                  <select id="type" name="type" value={formData.type} onChange={handleChange} className="p-2 border border-slate-300 rounded-md">
                    <option value="">Seleziona</option>
                    <option value="Reperto Singolo">Reperto Singolo</option>
                    <option value="Sacchetto">Sacchetto</option>
                  </select>
                </div>
                <div className="flex flex-col">
                  <label htmlFor="date" className="text-sm font-medium text-slate-700">Data (AAAAMMDD):</label>
                  <input type="text" id="date" name="date" value={formData.date} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" placeholder="Es. 20250728" />
                </div>
                <div className="flex flex-col">
                  <label htmlFor="findType" className="text-sm font-medium text-slate-700">Tipologia Reperto:</label>
                  <select id="findType" name="findType" value={formData.findType} onChange={handleChange} className="p-2 border border-slate-300 rounded-md">
                    <option value="">Seleziona</option>
                    {findTypes.map(type => <option key={type} value={type}>{type}</option>)}
                  </select>
                </div>
                <div className="flex flex-col md:col-span-2">
                  <label className="text-sm font-medium text-slate-700">Identificativo:</label>
                  <span className="text-blue-600 font-mono break-all">{identifier}</span>
                </div>
                <div className="flex flex-col">
                  <label htmlFor="nrReperti" className="text-sm font-medium text-slate-700">Nr. Reperti:</label>
                  <input type="number" id="nrReperti" name="nrReperti" value={formData.nrReperti} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                <div className="flex flex-col">
                  <label htmlFor="areaName" className="text-sm font-medium text-slate-700">Nome Area:</label>
                  <input type="text" id="areaName" name="areaName" value={formData.areaName} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                <div className="flex flex-col">
                  <label htmlFor="square" className="text-sm font-medium text-slate-700">Quadrato:</label>
                  <input type="text" id="square" name="square" value={formData.square} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                <div className="flex flex-col">
                  <label htmlFor="quadrant" className="text-sm font-medium text-slate-700">Quadrante:</label>
                  <input type="text" id="quadrant" name="quadrant" value={formData.quadrant} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                <div className="flex flex-col">
                  <label htmlFor="us" className="text-sm font-medium text-slate-700">US di riferimento:</label>
                  <select id="us" name="us" value={formData.us} onChange={handleChange} className="p-2 border border-slate-300 rounded-md">
                    <option value="">Seleziona</option>
                    {usOptions.map(us => <option key={us} value={us}>{us}</option>)}
                  </select>
                </div>
                <div className="flex flex-col md:col-span-2">
                  <label htmlFor="description" className="text-sm font-medium text-slate-700">Descrizione:</label>
                  <textarea id="description" name="description" value={formData.description} onChange={(e) => handleTextareaChange('description', e.target.value)} rows="4" className="p-2 border border-slate-300 rounded-md"></textarea>
                  <button
                    onClick={generateFindDescription}
                    disabled={llmLoading}
                    className="mt-2 bg-purple-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-purple-700 transition duration-200 shadow-sm text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {llmLoading ? 'Generazione...' : '‚ú® Suggerisci Descrizione'}
                  </button>
                </div>
              </div>
              <div className="mt-6 flex justify-end space-x-2">
                <button
                    onClick={onClose}
                    className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md active:scale-95"
                  >
                    Annulla
                  </button>
                <button
                  onClick={handleSubmit}
                  className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md active:scale-95"
                >
                  üíæ Salva Reperto
                </button>
              </div>
            </Modal>
          );
        };
        
        // NUOVO: Componente per la gestione e modifica dei Campioni
        const SampleEditDialog = ({ onClose, sampleEntry = null }) => {
          const { currentProject, updateSample } = React.useContext(AppContext);

          const getNextSampleId = () => {
            const sampleIds = Object.values(currentProject.samples || {}).map(entry => parseInt(entry.id.replace('C', ''), 10)).filter(id => !isNaN(id));
            const nextIdNum = sampleIds.length > 0 ? Math.max(...sampleIds) + 1 : 1;
            return `C${String(nextIdNum).padStart(3, '0')}`;
          };

          const initialData = sampleEntry || {
            id: getNextSampleId(),
            sampleType: '',
            collectionDate: new Date().toISOString().slice(0, 10).replace(/-/g, '_'),
            us: '',
            area: '',
            square: '',
            description: '',
            notes: '',
            photos: []
          };

          const [formData, setFormData] = React.useState(initialData);
          const [identifier, setIdentifier] = React.useState('');
          const [viewingPhoto, setViewingPhoto] = React.useState(null);


          React.useEffect(() => {
            const projCustomId = currentProject.customProjectId || 'N_A';
            const sampleId = formData.id;
            const date = formData.collectionDate;
            const type = formData.sampleType.replace(/ /g, '-').substring(0, 10);
            setIdentifier(sampleId && projCustomId && date && type ? `${sampleId}_${projCustomId}_${date}_${type}` : '...');
          }, [formData.id, formData.collectionDate, formData.sampleType, currentProject.customProjectId]);

          const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData({ ...formData, [name]: value });
          };
          
          const handlePhotoUpload = (e) => {
              const files = Array.from(e.target.files);
              if (files.length === 0) return;
              if ((formData.photos || []).length + files.length > 4) {
                  alert(`Puoi caricare un massimo di 4 foto. Ne hai gi√† ${(formData.photos || []).length}.`);
                  return;
              }

              files.forEach(file => {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      setFormData(prev => ({
                          ...prev,
                          photos: [...(prev.photos || []), event.target.result]
                      }));
                  };
                  reader.readAsDataURL(file);
              });
              e.target.value = null;
          };

          const handleRemovePhoto = (indexToRemove) => {
              setFormData(prev => ({
                  ...prev,
                  photos: prev.photos.filter((_, index) => index !== indexToRemove)
              }));
          };

          const handleSubmit = () => {
            if (!formData.sampleType || !formData.collectionDate || !formData.us) {
              alert("I campi 'Tipo Campione', 'Data Raccolta' e 'US' sono obbligatori.");
              return;
            }

            if (!sampleEntry) {
              const isDuplicate = Object.values(currentProject.samples || {}).some(
                (entry) => entry.id === formData.id
              );
              if (isDuplicate) {
                alert(`Un campione con ID ${formData.id} esiste gi√†.`);
                return;
              }
            }

            updateSample({ ...formData, identifier });
            onClose();
          };

          const sampleTypes = [
              "Campione di terra", 
              "Campione archeobotanico (macroresti)", 
              "Campione per flottazione", 
              "Campione per palinologia (polline)", 
              "Campione per datazione C14", 
              "Campione di malta/intonaco",
              "Campione per analisi chimiche",
              "Altro"
          ];
          const usOptions = Object.keys(currentProject.usCards || {}).map(usId => `US${currentProject.usCards[usId].usNumber}`);

          return (
            <>
            <PhotoViewerModal src={viewingPhoto} onClose={() => setViewingPhoto(null)} />
            <Modal show={true} onClose={onClose} title={sampleEntry ? "Modifica Scheda Campione" : "Nuova Scheda Campione"} className="w-full sm:max-w-3xl">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex flex-col">
                  <label className="text-sm font-medium text-slate-700">ID Progressivo:</label>
                  <span className="font-bold text-slate-900">{formData.id}</span>
                </div>
                <div className="flex flex-col">
                  <label className="text-sm font-medium text-slate-700">Identificativo Campione:</label>
                  <span className="text-blue-600 font-mono break-all">{identifier}</span>
                </div>
                <div className="flex flex-col">
                  <label htmlFor="sampleType" className="text-sm font-medium text-slate-700">Tipo Campione:</label>
                  <select id="sampleType" name="sampleType" value={formData.sampleType} onChange={handleChange} className="p-2 border border-slate-300 rounded-md">
                    <option value="">Seleziona</option>
                    {sampleTypes.map(type => <option key={type} value={type}>{type}</option>)}
                  </select>
                </div>
                 <div className="flex flex-col">
                  <label htmlFor="collectionDate" className="text-sm font-medium text-slate-700">Data Raccolta (YYYY_MM_DD):</label>
                  <input type="text" id="collectionDate" name="collectionDate" value={formData.collectionDate} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                <div className="flex flex-col">
                  <label htmlFor="us" className="text-sm font-medium text-slate-700">US di riferimento:</label>
                  <select id="us" name="us" value={formData.us} onChange={handleChange} className="p-2 border border-slate-300 rounded-md">
                    <option value="">Seleziona</option>
                    {usOptions.map(us => <option key={us} value={us}>{us}</option>)}
                  </select>
                </div>
                <div className="flex flex-col">
                  <label htmlFor="area" className="text-sm font-medium text-slate-700">Area:</label>
                  <input type="text" id="area" name="area" value={formData.area} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                <div className="flex flex-col">
                  <label htmlFor="square" className="text-sm font-medium text-slate-700">Quadrato:</label>
                  <input type="text" id="square" name="square" value={formData.square} onChange={handleChange} className="p-2 border border-slate-300 rounded-md" />
                </div>
                
                <div className="flex flex-col md:col-span-2">
                  <label htmlFor="description" className="text-sm font-medium text-slate-700">Descrizione (contesto, scopo, etc.):</label>
                  <textarea id="description" name="description" value={formData.description} onChange={handleChange} rows="4" className="p-2 border border-slate-300 rounded-md"></textarea>
                </div>
                 <div className="flex flex-col md:col-span-2">
                  <label htmlFor="notes" className="text-sm font-medium text-slate-700">Note:</label>
                  <textarea id="notes" name="notes" value={formData.notes} onChange={handleChange} rows="2" className="p-2 border border-slate-300 rounded-md"></textarea>
                </div>
                <div className="md:col-span-2">
                    <label className="text-sm font-medium text-slate-700 mb-2 block">Foto (max 4):</label>
                    <input
                        type="file"
                        id="samplePhotoUpload"
                        multiple
                        accept="image/*"
                        onChange={handlePhotoUpload}
                        disabled={(formData.photos || []).length >= 4}
                        className="hidden"
                    />
                    <button
                        onClick={() => document.getElementById('samplePhotoUpload').click()}
                        disabled={(formData.photos || []).length >= 4}
                        className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Aggiungi Foto dal PC
                    </button>
                    {(formData.photos || []).length >= 4 && (
                        <p className="text-sm text-red-500 mt-2">Limite massimo di 4 foto raggiunto.</p>
                    )}
                    <div className="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {(formData.photos || []).map((photoSrc, index) => (
                            <div key={index} className="relative group cursor-pointer" onClick={() => setViewingPhoto(photoSrc)}>
                                <img
                                    src={photoSrc}
                                    alt={`Anteprima ${index + 1}`}
                                    className="w-full h-auto object-cover rounded-md shadow-md aspect-square"
                                />
                                <button
                                    onClick={(e) => { e.stopPropagation(); handleRemovePhoto(index); }}
                                    className="absolute top-1 right-1 bg-red-600 text-white rounded-full p-0 w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                    title="Rimuovi foto"
                                >
                                    &times;
                                </button>
                                <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center">
                                    <p className="text-white text-lg font-bold opacity-0 group-hover:opacity-100">üëÅÔ∏è</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
              </div>
              <div className="mt-6 flex justify-end space-x-2">
                <button
                    onClick={onClose}
                    className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md active:scale-95"
                  >
                    Annulla
                  </button>
                <button
                  onClick={handleSubmit}
                  className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md active:scale-95"
                >
                  üíæ Salva Campione
                </button>
              </div>
            </Modal>
            </>
          );
        };
        
        // NUOVO: Componente per la gestione dei Campioni
        const SampleManagerDialog = ({ onClose }) => {
          const { currentProject, updateSample, deleteSample } = React.useContext(AppContext);
          const [showEditModal, setShowEditModal] = React.useState(false);
          const [selectedSample, setSelectedSample] = React.useState(null);
          const [showConfirmDelete, setShowConfirmDelete] = React.useState(false);
          const [sampleToDelete, setSampleToDelete] = React.useState(null);

          const sortedSamples = Object.values(currentProject.samples || {}).sort((a, b) => {
            return a.id.localeCompare(b.id);
          });

          const handleNewSample = () => {
            setSelectedSample(null);
            setShowEditModal(true);
          };

          const handleEditSample = (sample) => {
            setSelectedSample(sample);
            setShowEditModal(true);
          };

          const handleDeleteClick = (sampleId) => {
            setSampleToDelete(sampleId);
            setShowConfirmDelete(true);
          };

          const confirmDelete = () => {
            deleteSample(sampleToDelete);
            setSelectedSample(null);
            setShowConfirmDelete(false);
            setSampleToDelete(null);
          };

          return (
            <Modal show={true} onClose={onClose} title="Gestione Campioni" className="w-full sm:max-w-7xl">
              <div className="flex flex-col h-[75vh]">
                <div className="flex flex-wrap gap-2 mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                  <button onClick={handleNewSample} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md text-sm">Nuova Scheda Campione</button>
                  <button onClick={() => handleEditSample(selectedSample)} disabled={!selectedSample} className="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed text-sm">Modifica</button>
                  <button onClick={() => handleDeleteClick(selectedSample?.id)} disabled={!selectedSample} className="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed text-sm">Cancella</button>
                  <button onClick={() => exportToCsv('campioni.csv', Object.values(currentProject.samples || {}))} className="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 shadow-md text-sm">Esporta CSV</button>
                </div>

                <div className="overflow-x-auto flex-grow rounded-lg shadow-md border border-slate-200">
                  <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-100">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">ID</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Identificativo</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Data Raccolta</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Tipo Campione</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">US</th>
                        <th className="px-6 py-3 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Azioni</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                      {sortedSamples.length === 0 ? (
                        <tr>
                          <td colSpan="6" className="px-6 py-4 text-center text-slate-500">Nessun campione trovato.</td>
                        </tr>
                      ) : (
                        sortedSamples.map(sample => (
                          <tr
                            key={sample.id}
                            className={`transition-colors cursor-pointer ${selectedSample?.id === sample.id ? 'bg-blue-100' : 'hover:bg-slate-50'}`}
                            onClick={() => setSelectedSample(sample)}
                          >
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{sample.id}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-mono">{sample.identifier}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{sample.collectionDate}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{sample.sampleType}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{sample.us}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                              <div className="flex gap-2 justify-end">
                                <button onClick={(e) => { e.stopPropagation(); handleEditSample(sample); }} className="text-indigo-600 hover:text-indigo-900 text-xl" title="Modifica">‚úèÔ∏è</button>
                                <button onClick={(e) => { e.stopPropagation(); handleDeleteClick(sample.id); }} className="text-red-600 hover:text-red-900 text-xl" title="Elimina">üóëÔ∏è</button>
                              </div>
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {showEditModal && (
                <SampleEditDialog show={showEditModal} onClose={() => setShowEditModal(false)} sampleEntry={selectedSample} />
              )}
              <ConfirmDialog
                show={showConfirmDelete}
                message={`Sei sicuro di voler eliminare questo campione?`}
                onConfirm={confirmDelete}
                onCancel={() => setShowConfirmDelete(false)}
              />
            </Modal>
          );
        };

        const ReportsDialog = ({ onClose }) => {
          const { currentProject } = React.useContext(AppContext);
          const [reportContent, setReportContent] = React.useState('');

          React.useEffect(() => {
            const generateReport = () => {
              const allUSCards = currentProject.usCards || {};
              const allDiaryEntries = currentProject.diaryEntries || {};
              const allFindsEntries = currentProject.findsEntries || {};

              let totalUS = Object.keys(allUSCards).length;
              let completeUS = 0;
              let incompleteUS = 0;
              const usInDiary = new Set();
              const usWithFinds = new Set();
              const usTypeCounts = {};
              const allDates = [];

              for (const usId in allUSCards) {
                const suData = allUSCards[usId];
                const desc = suData.description?.trim() || '';
                const obs = suData.observations?.trim() || '';
                const interp = suData.interpretations?.trim() || '';
                const simp = suData.simplifiedRelations || {};

                const isComplete = (simp['Copre']?.trim() || simp['Coperto da']?.trim()) && desc && obs && interp;
                if (isComplete) {
                  completeUS++;
                } else {
                  incompleteUS++;
                }

                const usType = suData.type || 'Sconosciuto';
                usTypeCounts[usType] = (usTypeCounts[usType] || 0) + 1;

                if (suData.date) {
                  try {
                    const dateParts = suData.date.split(/[_-]/).map(Number);
                    if (dateParts.length === 3 && !isNaN(dateParts[0]) && !isNaN(dateParts[1]) && !isNaN(dateParts[2])) {
                        allDates.push(new Date(dateParts[0], dateParts[1] - 1, dateParts[2]));
                    }
                  } catch (e) {
                    console.warn("Could not parse date:", suData.date, e);
                  }
                }
              }

              for (const diaryId in allDiaryEntries) {
                const diaryData = allDiaryEntries[diaryId];
                const suIndagateStr = diaryData.suIndagate || '';
                suIndagateStr.split(',').forEach(suEntry => {
                  const suNumMatch = suEntry.trim().match(/\d+/);
                  if (suNumMatch) {
                    const suNum = parseInt(suNumMatch[0], 10);
                    const foundUs = Object.values(allUSCards).find(card => card.usNumber === suNum);
                    if (foundUs) {
                      usInDiary.add(`US${foundUs.usNumber}`);
                    }
                  }
                });
              }

              for (const findId in allFindsEntries) {
                const findData = allFindsEntries[findId];
                if (findData.us) {
                  usWithFinds.add(findData.us);
                }
              }

              let report = `--- Report Riassuntivo Schede US ---\n\n`;
              report += `Dati Progetto: ${currentProject.name || 'N/A'} (Codice: ${currentProject.customProjectId || 'N/A'} | ID Interno: ${currentProject.id || 'N/A'})\n\n`;
              report += `Totale Schede US: ${totalUS}\n`;
              report += `Schede US Complete: ${completeUS}\n`;
              report += `Schede US Incomplete: ${incompleteUS}\n`;
              report += `Schede US presenti nel Diario: ${usInDiary.size}\n`;
              report += `Schede US con Reperti Associati: ${usWithFinds.size}\n\n`;

              report += "Riepilogo per Tipo di US:\n";
              Object.keys(usTypeCounts).sort().forEach(usType => {
                report += `- ${usType}: ${usTypeCounts[usType]}\n`;
              });
              report += "\n";

              if (allDates.length > 0) {
                const oldestDate = new Date(Math.min(...allDates)).toLocaleDateString('it-IT');
                const mostRecentDate = new Date(Math.max(...allDates)).toLocaleDateString('it-IT');
                report += `Data Scheda US pi√π Vecchia: ${oldestDate}\n`;
                report += `Data Scheda US pi√π Recente: ${mostRecentDate}\n`;
              } else {
                report += "Nessuna data trovata nelle schede US.\n";
              }

              setReportContent(report);
            };

            generateReport();
          }, [currentProject]);

          return (
            <Modal show={true} onClose={onClose} title="Report Riassuntivo Schede US" className="w-full sm:max-w-3xl">
              <div className="bg-slate-100 p-4 rounded-md h-96 overflow-y-auto font-mono text-sm text-slate-800 border border-slate-200">
                <pre>{reportContent}</pre>
              </div>
              <div className="mt-6 flex justify-end">
                <button
                  onClick={onClose}
                  className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md"
                >
                  Chiudi
                </button>
              </div>
            </Modal>
          );
        };

        const HarrisMatrixDialog = ({ onClose }) => {
          const { currentProject, updateHarrisLayout } = React.useContext(AppContext);
          const matrixContainerRef = React.useRef(null);
          const matrixContentRef = React.useRef(null);
          const [filteredUS, setFilteredUS] = React.useState({});
          const [filterType, setFilterType] = React.useState('Tutti');
          const [filterArea, setFilterArea] = React.useState('');
          const [filterSector, setFilterSector] = React.useState('');
          const [filterDating, setFilterDating] = React.useState('');
          const [showFilters, setShowFilters] = React.useState(false);
          const [nodePositions, setNodePositions] = React.useState(currentProject.harrisLayout || {});
          const [svgLines, setSvgLines] = React.useState([]);

          const dragInfo = React.useRef({ active: false, item: null });
          const scale = React.useRef(1);
          const panOffset = React.useRef({ x: 0, y: 0 });
          const isPanning = React.useRef(false);
          const lastPanPoint = React.useRef({ x: 0, y: 0 });
          const touchInfo = React.useRef({
              active: false,
              startX: 0,
              startY: 0,
              lastDistance: 0,
              lastMidX: 0,
              lastMidY: 0,
              mode: 'none'
          });

          const COLORS = {
            default: "#C6F4FA",
            negative: "#FFCDD2",
            muraria: "#E0E0E0",
            virtuale: "#B2EBF2",
            highlight: "red",
            cycleEdgeColor: "black",
            normalEdgeColor: "black"
          };

          const NODE_WIDTH = 80;
          const NODE_HEIGHT = 40;
          const H_SPACING = 40;
          const V_SPACING = 60;
          const PADDING = 50;

          const sorted = (arr) => [...arr].sort();

          const getBoundaryPoint = (cx, cy, tx, ty, rectWidth, rectHeight) => {
              const halfW = rectWidth / 2;
              const halfH = rectHeight / 2;
              const dx = tx - cx;
              const dy = ty - cy;

              if (dx === 0 && dy === 0) {
                  return { x: cx, y: cy };
              }

              let t = Infinity;
              let intersectX = cx, intersectY = cy;

              if (dx !== 0) {
                  [-halfW, halfW].forEach(boundaryX => {
                      const tVal = boundaryX / dx;
                      if (tVal > 0 && tVal < t) {
                          const y_at_t = cy + tVal * dy;
                          if (y_at_t >= cy - halfH && y_at_t <= cy + halfH) {
                              t = tVal;
                              intersectX = cx + tVal * dx;
                              intersectY = y_at_t;
                          }
                      }
                  });
              }

              if (dy !== 0) {
                  [-halfH, halfH].forEach(boundaryY => {
                      const tVal = boundaryY / dy;
                      if (tVal > 0 && tVal < t) {
                          const x_at_t = cx + tVal * dx;
                          if (x_at_t >= cx - halfW && x_at_t <= cx + halfW) {
                              t = tVal;
                              intersectX = x_at_t;
                              intersectY = cy + tVal * dy;
                          }
                      }
                  });
              }
              
              if (t === Infinity) {
                  return { x: tx, y: ty };
              }

              return { x: intersectX, y: intersectY };
          };

          const getGraphConsistencyInfo = React.useCallback(() => {
              const cycles = new Set();
              const inconsistentEdges = new Set();
              const allUS = Object.values(currentProject.usCards || {});

              const reverseRelations = {};
              for (const suData of allUS) {
                  const suName = `US${suData.usNumber}`;
                  reverseRelations[suName] = new Set();
              }
              for (const suData of allUS) {
                  const suName = `US${suData.usNumber}`;
                  const relations = suData.simplifiedRelations || {};
                  const coversList = (relations['Copre'] || '').split(',').map(s => s.trim()).filter(s => s !== '');
                  for (const coveredSuName of coversList) {
                      reverseRelations[coveredSuName]?.add(suName);
                  }
              }

              for (const suData of allUS) {
                  const suName = `US${suData.usNumber}`;
                  const relations = suData.simplifiedRelations || {};

                  const coversList = (relations['Copre'] || '').split(',').map(s => s.trim()).filter(s => s !== '');
                  for (const coveredSuName of coversList) {
                      const coveredSuData = allUS.find(us => `US${us.usNumber}` === coveredSuName);
                      if (coveredSuData) {
                          const theirCoveredBy = (coveredSuData.simplifiedRelations?.['Coperto da'] || '').split(',').map(s => s.trim()).filter(s => s !== '');
                          if (!theirCoveredBy.includes(suName)) {
                              inconsistentEdges.add(`${suName}->${coveredSuName}`);
                          }
                          const theirCovers = (coveredSuData.simplifiedRelations?.['Copre'] || '').split(',').map(s => s.trim()).filter(s => s !== '');
                          if (theirCovers.includes(suName)) {
                              cycles.add(JSON.stringify(sorted([suName, coveredSuName])));
                          }
                      }
                  }

                  const coveredByList = (relations['Coperto da'] || '').split(',').map(s => s.trim()).filter(s => s !== '');
                  for (const coveringSuName of coveredByList) {
                      const coveringSuData = allUS.find(us => `US${us.usNumber}` === coveringSuName);
                      if (coveringSuData) {
                          const theirCovers = (coveringSuData.simplifiedRelations?.['Copre'] || '').split(',').map(s => s.trim()).filter(s => s !== '');
                          if (!theirCovers.includes(suName)) {
                              inconsistentEdges.add(`${coveringSuName}->${suName}`);
                          }
                      }
                  }
              }
              return { cycles, inconsistentEdges };
          }, [currentProject.usCards]);

          const drawGraph = React.useCallback(() => {
            const container = matrixContainerRef.current;
            const content = matrixContentRef.current;
            if (!container || !content) return;

            const adj = {};
            const reverseAdj = {};
            const currentFilteredUSNames = Object.keys(filteredUS).map(usId => `US${filteredUS[usId].usNumber}`);

            for (const usId in filteredUS) {
              const suName = `US${filteredUS[usId].usNumber}`;
              adj[suName] = [];
              reverseAdj[suName] = [];
            }

            for (const usId in filteredUS) {
              const suName = `US${filteredUS[usId].usNumber}`;
              const relations = filteredUS[usId].simplifiedRelations || {};
              const coversStr = relations['Copre'] || '';
              coversStr.split(',').forEach(coveredSuName => {
                const trimmedName = coveredSuName.trim();
                if (trimmedName && currentFilteredUSNames.includes(trimmedName)) {
                  adj[suName].push(trimmedName);
                  reverseAdj[trimmedName].push(suName);
                }
              });
              const coveredByStr = relations['Coperto da'] || '';
              coveredByStr.split(',').forEach(coveringSuName => {
                const trimmedName = coveringSuName.trim();
                if (trimmedName && currentFilteredUSNames.includes(trimmedName)) {
                  adj[trimmedName].push(suName);
                }
              });
            }

            const roots = currentFilteredUSNames.filter(name => !reverseAdj[name] || reverseAdj[name].length === 0);
            const levels = {};
            const queue = [...roots];
            for (const node of queue) {
              levels[node] = 0;
            }

            let head = 0;
            while (head < queue.length) {
              const u = queue[head];
              head++;
              for (const v of adj[u] || []) {
                if (levels[v] === undefined || levels[v] < levels[u] + 1) {
                  levels[v] = levels[u] + 1;
                  if (!queue.includes(v)) {
                    queue.push(v);
                  }
                }
              }
            }

            for (const node of currentFilteredUSNames) {
              if (levels[node] === undefined) {
                levels[node] = 0;
              }
            }

            const maxLevel = Math.max(0, ...Object.values(levels));
            const nodesByLevel = Array.from({ length: maxLevel + 1 }, () => []);
            for (const node in levels) {
              nodesByLevel[levels[node]].push(node);
            }

            nodesByLevel.forEach(level => level.sort());

            let newPositions = { ...nodePositions };
            let layoutChanged = false;
            const currentLayoutUSNames = Object.keys(newPositions);
            const filteredUSNamesArray = Object.keys(filteredUS).map(usId => `US${filteredUS[usId].usNumber}`);

            if (currentLayoutUSNames.length !== filteredUSNamesArray.length ||
                !filteredUSNamesArray.every(name => currentLayoutUSNames.includes(name))) {
                newPositions = {};
                layoutChanged = true;
            }

            if (layoutChanged) {
              scale.current = 1;
              panOffset.current = { x: 0, y: 0 };

              for (let levelIdx = 0; levelIdx < nodesByLevel.length; levelIdx++) {
                const levelNodes = nodesByLevel[levelIdx];
                const levelWidth = levelNodes.length * (NODE_WIDTH + H_SPACING) - H_SPACING;
                const startX = (container.offsetWidth - levelWidth) / 2;
                const yPos = PADDING + levelIdx * (NODE_HEIGHT + V_SPACING);

                for (let nodeIdx = 0; nodeIdx < levelNodes.length; nodeIdx++) {
                  const suName = levelNodes[nodeIdx];
                  const xPos = startX + nodeIdx * (NODE_WIDTH + H_SPACING) + NODE_WIDTH / 2;
                  const yCenterPos = yPos + NODE_HEIGHT / 2;
                  newPositions[suName] = { x: xPos, y: yCenterPos };
                }
              }
              setNodePositions(newPositions);
            }

            const { cycles, inconsistentEdges } = getGraphConsistencyInfo();
            const linesToDraw = [];
            for (const suName in adj) {
              const fromPos = newPositions[suName];
              if (!fromPos) continue;
              for (const childSuName of adj[suName]) {
                const toPos = newPositions[childSuName];
                if (!toPos) continue;

                const isCycle = cycles.has(JSON.stringify(sorted([suName, childSuName])));
                const isInconsistent = inconsistentEdges.has(`${suName}->${childSuName}`);
                let strokeColor = COLORS.normalEdgeColor;
                let strokeDasharray = '';
                let markerEnd = 'url(#arrowhead_solid_black)';

                if (isCycle) {
                    strokeColor = COLORS.cycleEdgeColor;
                    markerEnd = 'url(#arrowhead_solid_black)';
                } else if (isInconsistent) {
                    strokeColor = COLORS.highlight;
                    strokeDasharray = '5,3';
                    markerEnd = 'url(#arrowhead_dashed_red)';
                }

                const startPoint = getBoundaryPoint(fromPos.x, fromPos.y, toPos.x, toPos.y, NODE_WIDTH, NODE_HEIGHT);
                const endPoint = getBoundaryPoint(toPos.x, toPos.y, fromPos.x, fromPos.y, NODE_WIDTH, NODE_HEIGHT);

                linesToDraw.push({
                  x1: startPoint.x, y1: startPoint.y, x2: endPoint.x, y2: endPoint.y,
                  stroke: strokeColor, strokeWidth: 1.5, strokeDasharray, markerEnd,
                });
              }
            }
            setSvgLines(linesToDraw);

            let contentMinX = Infinity, contentMinY = Infinity, contentMaxX = -Infinity, contentMaxY = -Infinity;
            if (currentFilteredUSNames.length > 0) {
                for (const usName of currentFilteredUSNames) {
                    const pos = newPositions[usName];
                    if (pos) {
                        contentMinX = Math.min(contentMinX, pos.x - NODE_WIDTH / 2);
                        contentMinY = Math.min(contentMinY, pos.y - NODE_HEIGHT / 2);
                        contentMaxX = Math.max(contentMaxX, pos.x + NODE_WIDTH / 2);
                        contentMaxY = Math.max(contentMaxY, pos.y + NODE_HEIGHT / 2);
                    }
                }
                linesToDraw.forEach(line => {
                    contentMinX = Math.min(contentMinX, line.x1, line.x2);
                    contentMinY = Math.min(contentMinY, line.y1, line.y2);
                    contentMaxX = Math.max(contentMaxX, line.x1, line.x2);
                    contentMaxY = Math.max(contentMaxY, line.y1, line.y2);
                });
            } else {
                contentMinX = 0; contentMinY = 0;
                contentMaxX = container.offsetWidth; contentMaxY = container.offsetHeight;
            }

            const contentPaddingVal = 100;
            const calculatedWidth = (contentMaxX - contentMinX) + 2 * contentPaddingVal;
            const calculatedHeight = (contentMaxY - contentMinY) + 2 * contentPaddingVal;

            content.style.width = `${Math.max(container.offsetWidth, calculatedWidth)}px`;
            content.style.height = `${Math.max(container.offsetHeight, calculatedHeight)}px`;
            content.style.transform = `translate(${panOffset.current.x}px, ${panOffset.current.y}px) scale(${scale.current})`;
            content.style.transformOrigin = '0 0';
          }, [filteredUS, nodePositions, getGraphConsistencyInfo]);

          React.useEffect(() => {
            drawGraph();
          }, [drawGraph]);

          const applyFilters = React.useCallback(() => {
            const newFilteredUS = {};
            for (const usId in currentProject.usCards || {}) {
              const us = currentProject.usCards[usId];
              if (filterType !== 'Tutti' && us.type !== filterType) continue;
              if (filterArea && !us.area?.toLowerCase().includes(filterArea.toLowerCase())) continue;
              if (filterSector && !us.sector?.toLowerCase().includes(filterSector.toLowerCase())) continue;
              if (filterDating && !us.dating?.toLowerCase().includes(filterDating.toLowerCase())) continue;
              newFilteredUS[usId] = us;
            }
            setFilteredUS(newFilteredUS);
          }, [currentProject.usCards, filterType, filterArea, filterSector, filterDating]);

          const resetFilters = () => {
            setFilterType('Tutti');
            setFilterArea('');
            setFilterSector('');
            setFilterDating('');
            setFilteredUS(currentProject.usCards || {});
          };

          React.useEffect(() => {
            applyFilters();
          }, [currentProject.usCards, applyFilters]);

          const onMouseDown = (e) => {
            const targetNode = e.target.closest('.us-node');
            if (e.button === 0) {
              if (targetNode) {
                const suName = targetNode.textContent;
                dragInfo.current = { active: true, item: suName };
                matrixContainerRef.current.classList.add('grabbing');
              } else {
                isPanning.current = true;
                lastPanPoint.current = { x: e.clientX, y: e.clientY };
                matrixContainerRef.current.classList.add('grabbing');
              }
            }
          };

          const onMouseMove = (e) => {
            const container = matrixContainerRef.current;
            const content = matrixContentRef.current;
            if (!container || !content) return;

            if (dragInfo.current.active) {
              const { item } = dragInfo.current;
              const containerRect = container.getBoundingClientRect();
              const mouseXInContainer = e.clientX - containerRect.left;
              const mouseYInContainer = e.clientY - containerRect.top;
              const newX = (mouseXInContainer - panOffset.current.x) / scale.current;
              const newY = (mouseYInContainer - panOffset.current.y) / scale.current;

              setNodePositions(prev => ({
                ...prev,
                [item]: { x: newX, y: newY }
              }));
            } else if (isPanning.current) {
              const dx = e.clientX - lastPanPoint.current.x;
              const dy = e.clientY - lastPanPoint.current.y;
              panOffset.current.x += dx;
              panOffset.current.y += dy;
              lastPanPoint.current = { x: e.clientX, y: e.clientY };
              drawGraph();
            }
          };

          const onMouseUp = () => {
            dragInfo.current.active = false;
            isPanning.current = false;
            matrixContainerRef.current.classList.remove('grabbing');
          };

          const onWheel = (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
            const container = matrixContainerRef.current;
            const content = matrixContentRef.current;
            if (!container || !content) return;

            const containerRect = container.getBoundingClientRect();
            const mouseX = e.clientX - containerRect.left;
            const mouseY = e.clientY - containerRect.top;

            panOffset.current.x = mouseX - (mouseX - panOffset.current.x) * zoomFactor;
            panOffset.current.y = mouseY - (mouseY - panOffset.current.y) * zoomFactor;
            scale.current *= zoomFactor;
            drawGraph();
          };

          const onTouchStart = (e) => {
              e.preventDefault();
              const container = matrixContainerRef.current;
              if (!container) return;

              if (e.touches.length === 1) {
                  touchInfo.current.active = true;
                  touchInfo.current.startX = e.touches[0].clientX;
                  touchInfo.current.startY = e.touches[0].clientY;
                  touchInfo.current.mode = 'pan';
                  lastPanPoint.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                  container.classList.add('grabbing');
              } else if (e.touches.length === 2) {
                  touchInfo.current.active = true;
                  touchInfo.current.mode = 'zoom';
                  const touch1 = e.touches[0];
                  const touch2 = e.touches[1];
                  touchInfo.current.lastDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
                  touchInfo.current.lastMidX = (touch1.clientX + touch2.clientX) / 2;
                  touchInfo.current.lastMidY = (touch1.clientY + touch2.clientY) / 2;
                  container.classList.add('grabbing');
              }
          };

          const onTouchMove = (e) => {
              e.preventDefault();
              const container = matrixContainerRef.current;
              const content = matrixContentRef.current;
              if (!container || !content || !touchInfo.current.active) return;

              if (touchInfo.current.mode === 'pan' && e.touches.length === 1) {
                  const dx = e.touches[0].clientX - lastPanPoint.current.x;
                  const dy = e.touches[0].clientY - lastPanPoint.current.y;
                  panOffset.current.x += dx;
                  panOffset.current.y += dy;
                  lastPanPoint.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                  drawGraph();
              } else if (touchInfo.current.mode === 'zoom' && e.touches.length === 2) {
                  const touch1 = e.touches[0];
                  const touch2 = e.touches[1];
                  const newDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
                  const newMidX = (touch1.clientX + touch2.clientX) / 2;
                  const newMidY = (touch1.clientY + touch2.clientY) / 2;

                  const zoomFactor = newDistance / touchInfo.current.lastDistance;
                  const dx = newMidX - touchInfo.current.lastMidX;
                  const dy = newMidY - touchInfo.current.lastMidY;

                  panOffset.current.x += dx;
                  panOffset.current.y += dy;

                  const containerRect = container.getBoundingClientRect();
                  const mouseX = newMidX - containerRect.left;
                  const mouseY = newMidY - containerRect.top;

                  panOffset.current.x = mouseX - (mouseX - panOffset.current.x) * zoomFactor;
                  panOffset.current.y = mouseY - (mouseY - panOffset.current.y) * zoomFactor;
                  scale.current *= zoomFactor;

                  touchInfo.current.lastDistance = newDistance;
                  touchInfo.current.lastMidX = newMidX;
                  touchInfo.current.lastMidY = newMidY;

                  drawGraph();
              }
          };

          const onTouchEnd = () => {
              touchInfo.current.active = false;
              touchInfo.current.mode = 'none';
              matrixContainerRef.current.classList.remove('grabbing');
          };

          const saveLayout = () => {
            updateHarrisLayout(nodePositions);
            alert('Layout salvato.');
          };

          const checkConsistency = () => {
            const { cycles, inconsistentEdges } = getGraphConsistencyInfo();
            let report = "Controllo Coerenza Rapporti:\n\n";
            if (cycles.size > 0) {
              report += "Cicli Logici Rilevati (A-B e B-A):\n";
              cycles.forEach(cycle => {
                const [u, v] = JSON.parse(cycle);
                report += `- ${u} <--> ${v}\n`;
              });
              report += "\n";
            }
            if (inconsistentEdges.size > 0) {
              report += "Incoerenze di Reciprocit√† Rilevate:\n";
              inconsistentEdges.forEach(edge => {
                report += `- ${edge} (relazione non reciproca)\n`;
              });
            }
            if (cycles.size === 0 && inconsistentEdges.size === 0) {
              report = "Nessun ciclo logico o incoerenza di reciprocit√† rilevata.";
            }
            alert(report);
          };

          const exportSvg = () => {
            const container = matrixContainerRef.current;
            if (!container) return;

            // Calculate bounding box of all nodes
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            const currentFilteredUSNames = Object.keys(filteredUS).map(usId => `US${filteredUS[usId].usNumber}`);

            for (const usName of currentFilteredUSNames) {
              const pos = nodePositions[usName];
              if (pos) {
                // nodePositions store center, so adjust for top-left of rect
                minX = Math.min(minX, pos.x - NODE_WIDTH / 2);
                minY = Math.min(minY, pos.y - NODE_HEIGHT / 2);
                maxX = Math.max(maxX, pos.x + NODE_WIDTH / 2);
                maxY = Math.max(maxY, pos.y + NODE_HEIGHT / 2);
              }
            }

            if (minX === Infinity) {
              alert('Canvas vuoto, niente da esportare.');
              return;
            }

            const padding = 50; // Increased padding for better margins
            const legendHeight = 150; // Space for the legend
            const totalWidth = maxX - minX + 2 * padding;
            const totalHeight = maxY - minY + 2 * padding + legendHeight;

            let svgContent = `<svg width="${totalWidth}" height="${totalHeight}" viewBox="${minX - padding} ${minY - padding} ${totalWidth} ${totalHeight}" xmlns="http://www.w3.org/2000/svg" font-family="Inter, sans-serif">\n`;
            svgContent += `<!-- Exported: ${new Date().toISOString()} -->\n`;
            svgContent += `<!-- Project: ${currentProject.name || 'N/D'} -->\n`;

            // Define arrow markers
            svgContent += '<defs>\n';
            svgContent += '  <marker id="arrowhead_solid_black" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">\n';
            svgContent += '    <polygon points="0 0, 10 3.5, 0 7" fill="black" />\n';
            svgContent += '  </marker>\n';
            svgContent += '  <marker id="arrowhead_dashed_red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">\n';
            svgContent += '    <polygon points="0 0, 10 3.5, 0 7" fill="red" />\n';
            svgContent += '  </marker>\n';
            svgContent += '</defs>\n';

            // Draw nodes
            for (const usId in filteredUS) {
              const us = filteredUS[usId];
              const suName = `US${us.usNumber}`;
              const pos = nodePositions[suName];
              if (pos) {
                const color = us.negative ? COLORS.negative :
                              us.type.includes('Muraria') ? COLORS.muraria :
                              us.type.includes('Virtuale') ? COLORS.virtuale :
                              COLORS.default;
                // Adjust x, y for the center-aligned divs
                const rectX = pos.x - NODE_WIDTH / 2;
                const rectY = pos.y - NODE_HEIGHT / 2;

                svgContent += `<rect x="${rectX}" y="${rectY}" width="${NODE_WIDTH}" height="${NODE_HEIGHT}" fill="${color}" stroke="black" stroke-width="1.5" rx="5" ry="5"/>\n`;
                svgContent += `<text x="${pos.x}" y="${pos.y}" text-anchor="middle" dominant-baseline="central" font-size="10px" font-weight="bold" fill="black">${suName}</text>\n`;
              }
            }

            // Draw edges
            const adj = {};
            const { cycles, inconsistentEdges } = getGraphConsistencyInfo(); // Get consistency info for export

            for (const usId in filteredUS) {
              const suName = `US${filteredUS[usId].usNumber}`;
              adj[suName] = [];
            }
            for (const usId in filteredUS) {
              const suName = `US${filteredUS[usId].usNumber}`;
              const relations = filteredUS[usId].simplifiedRelations || {};
              const coversStr = relations['Copre'] || '';
              coversStr.split(',').forEach(coveredSuName => {
                const trimmedName = coveredSuName.trim();
                if (trimmedName && currentFilteredUSNames.includes(trimmedName)) {
                  adj[suName].push(trimmedName);
                }
              });
              const coveredByStr = relations['Coperto da'] || '';
              coveredByStr.split(',').forEach(coveringSuName => {
                const trimmedName = coveringSuName.trim();
                if (trimmedName && currentFilteredUSNames.includes(trimmedName)) {
                  adj[trimmedName].push(suName);
                }
              });
            }

            for (const suName in adj) {
              const fromPos = nodePositions[suName];
              if (!fromPos) continue;

              for (const childSuName of adj[suName]) {
                const toPos = nodePositions[childSuName];
                if (!toPos) continue;

                const isCycle = cycles.has(JSON.stringify(sorted([suName, childSuName])));
                const isInconsistent = inconsistentEdges.has(`${suName}->${childSuName}`);

                let strokeColor = "black"; // Default to black for consistent relations
                let dashArray = '';
                let markerUrl = 'url(#arrowhead_solid_black)';

                if (isCycle) {
                    strokeColor = "black";
                    dashArray = '';
                    markerUrl = 'url(#arrowhead_solid_black)';
                } else if (isInconsistent) {
                    strokeColor = "red";
                    dashArray = '5,3';
                    markerUrl = 'url(#arrowhead_dashed_red)';
                }

                // Calculate start and end points on node boundaries for SVG export
                const startPoint = getBoundaryPoint(fromPos.x, fromPos.y, toPos.x, toPos.y, NODE_WIDTH, NODE_HEIGHT);
                const endPoint = getBoundaryPoint(toPos.x, toPos.y, fromPos.x, fromPos.y, NODE_WIDTH, NODE_HEIGHT);

                svgContent += `<line x1="${startPoint.x}" y1="${startPoint.y}" x2="${endPoint.x}" y2="${endPoint.y}" stroke="${strokeColor}" stroke-width="1.5" stroke-linecap="round" ${dashArray ? `stroke-dasharray="${dashArray}"` : ''} marker-end="${markerUrl}"/>\n`;
              }
            }

            // Legend in SVG
            const legendItems = { "US Negativa": COLORS["negative"], "US Muraria": COLORS["muraria"], "US Virtuale": COLORS["virtuale"], "Altra US": COLORS["default"] };
            const lBoxSize = 15;
            const lPadding = 5;
            const legendWidth = 180;
            const legendHeightCalc = Object.keys(legendItems).length * (lBoxSize + lPadding) + lPadding;

            const lx = minX - padding; // Position relative to the SVG viewBox
            const ly = maxY + padding;

            svgContent += `<g transform="translate(${lx}, ${ly})">\n`;
            svgContent += `<rect x="0" y="0" width="${legendWidth}" height="${legendHeightCalc}" fill="white" stroke="black" rx="5" ry="5"/>\n`;
            let currentY = lPadding;
            for (const text in legendItems) {
              svgContent += `<rect x="${lPadding}" y="${currentY}" width="${lBoxSize}" height="${lBoxSize}" fill="${legendItems[text]}" stroke="black" rx="3" ry="3"/>\n`;
              svgContent += `<text x="${lBoxSize + 2 * lPadding}" y="${currentY + lBoxSize / 2}" dominant-baseline="central" font-size="12px" fill="black">${text}</text>\n`;
              currentY += lBoxSize + lPadding;
            }
            svgContent += '</g>\n';

            svgContent += '</svg>';

            const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'matrix.svg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Matrice esportata in matrix.svg');
          };

          return (
            <Modal show={true} onClose={onClose} title="Matrix di Harris" className="w-full sm:max-w-6xl">
              <div className="flex flex-col h-[75vh]">
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 p-4 bg-slate-100 rounded-lg shadow-sm mb-4">
                  <h3 className="text-lg font-semibold text-slate-800 hidden sm:block">Filtri:</h3>
                  <button
                    onClick={() => setShowFilters(!showFilters)}
                    className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md w-full sm:w-auto"
                  >
                    {showFilters ? 'Nascondi Filtri' : 'Mostra Filtri'}
                  </button>
                  <div className={`filter-content ${showFilters ? 'expanded' : 'collapsed'} flex flex-wrap gap-4 w-full`}>
                    <div className="flex flex-col mb-2 sm:mb-0">
                      <label className="text-sm font-medium text-slate-700">Tipo US:</label>
                      <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="p-2 border rounded-md">
                        <option value="Tutti">Tutti</option>
                        {['SU', 'SU Muraria', 'SU Rivestimento', 'SU Documentaria', 'SU Virtuale strutturale', 'SU Virtuale non strutturale'].map(type => (
                          <option key={type} value={type}>{type}</option>
                        ))}
                      </select>
                    </div>
                    <div className="flex flex-col mb-2 sm:mb-0">
                      <label className="text-sm font-medium text-slate-700">Area:</label>
                      <input type="text" value={filterArea} onChange={(e) => setFilterArea(e.target.value)} className="p-2 border rounded-md" />
                    </div>
                    <div className="flex flex-col mb-2 sm:mb-0">
                      <label className="text-sm font-medium text-slate-700">Settore:</label>
                      <input type="text" value={filterSector} onChange={(e) => setFilterSector(e.target.value)} className="p-2 border rounded-md" />
                    </div>
                    <div className="flex flex-col mb-2 sm:mb-0">
                      <label className="text-sm font-medium text-slate-700">Datazione:</label>
                      <input type="text" value={filterDating} onChange={(e) => setFilterDating(e.target.value)} className="p-2 border rounded-md" />
                    </div>
                    <div className="flex items-end gap-2 mt-2 sm:mt-0">
                      <button onClick={applyFilters} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md text-sm">Applica Filtri</button>
                      <button onClick={resetFilters} className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md text-sm">Resetta Filtri</button>
                    </div>
                  </div>
                </div>

                <div
                  ref={matrixContainerRef}
                  className="matrix-container flex-grow border border-slate-300 rounded-lg overflow-x-auto bg-white"
                  onMouseDown={onMouseDown}
                  onMouseMove={onMouseMove}
                  onMouseUp={onMouseUp}
                  onWheel={onWheel}
                  onTouchStart={onTouchStart}
                  onTouchMove={onTouchMove}
                  onTouchEnd={onTouchEnd}
                >
                  <div ref={matrixContentRef} className="matrix-content">
                    <svg className="absolute inset-0 w-full h-full pointer-events-none">
                        <defs>
                            <marker id="arrowhead_solid_black" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="black" />
                            </marker>
                            <marker id="arrowhead_dashed_red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="red" />
                            </marker>
                        </defs>
                        {svgLines.map((line, index) => (
                            <line
                                key={index}
                                x1={line.x1} y1={line.y1}
                                x2={line.x2} y2={line.y2}
                                stroke={line.stroke}
                                strokeWidth={line.strokeWidth}
                                strokeDasharray={line.strokeDasharray}
                                markerEnd={line.markerEnd}
                            />
                        ))}
                    </svg>
                    {Object.values(filteredUS).map(us => {
                        const suName = `US${us.usNumber}`;
                        const pos = nodePositions[suName];
                        const color = us.negative ? COLORS.negative :
                                      us.type.includes('Muraria') ? COLORS.muraria :
                                      us.type.includes('Virtuale') ? COLORS.virtuale :
                                      COLORS.default;
                        return pos && (
                            <div
                                key={us.id}
                                id={`us-node-${us.id}`}
                                className="us-node absolute rounded-md flex items-center justify-center text-center font-bold text-xs border border-black"
                                style={{
                                    width: NODE_WIDTH,
                                    height: NODE_HEIGHT,
                                    left: pos.x,
                                    top: pos.y,
                                    backgroundColor: color,
                                }}
                            >
                                {suName}
                            </div>
                        );
                    })}
                  </div>
                  {Object.keys(filteredUS).length === 0 && (
                    <div className="absolute inset-0 flex items-center justify-center text-slate-500 text-lg">
                      Nessuna scheda US trovata o corrispondente ai filtri.
                    </div>
                  )}
                </div>

                <div className="flex flex-wrap gap-2 mt-4 justify-center">
                  <button onClick={saveLayout} className="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md">Salva Layout</button>
                  <button onClick={exportSvg} className="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 shadow-md">Esporta SVG</button>
                  <button onClick={checkConsistency} className="bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-700 transition duration-200 shadow-md">Controlla Coerenza</button>
                  <button onClick={onClose} className="bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-400 transition duration-200 shadow-md">Chiudi</button>
                </div>
              </div>
            </Modal>
          );
        };
        
        const MapViewDialog = ({ onClose }) => {
            const { currentProject } = React.useContext(AppContext);
            const mapRef = React.useRef(null);

            React.useEffect(() => {
                if (mapRef.current) return; // Initialize map only once

                const redIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });

                const blueIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });

                mapRef.current = L.map('map-container').setView([46.03, 11.9], 13); // Default view on Feltre

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(mapRef.current);

                const usPoints = L.layerGroup();
                const diaryPoints = L.layerGroup();
                const allPoints = [];

                Object.values(currentProject.usCards || {}).forEach(us => {
                    if (us.latitude && us.longitude) {
                        const lat = parseFloat(us.latitude);
                        const lon = parseFloat(us.longitude);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            L.marker([lat, lon], { icon: redIcon })
                                .addTo(usPoints)
                                .bindPopup(`<b>Scheda US ${us.usNumber}</b><br>Tipo: ${us.type}`);
                            allPoints.push([lat, lon]);
                        }
                    }
                });

                Object.values(currentProject.diaryEntries || {}).forEach(entry => {
                    if (entry.latitude && entry.longitude) {
                        const lat = parseFloat(entry.latitude);
                        const lon = parseFloat(entry.longitude);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            L.marker([lat, lon], { icon: blueIcon })
                                .addTo(diaryPoints)
                                .bindPopup(`<b>Diario: ${entry.date}</b><br>${entry.workAddress || ''}`);
                            allPoints.push([lat, lon]);
                        }
                    }
                });

                usPoints.addTo(mapRef.current);
                diaryPoints.addTo(mapRef.current);

                const overlayMaps = {
                    "Schede US (Rosse)": usPoints,
                    "Voci Diario (Blu)": diaryPoints
                };
                
                L.control.layers(null, overlayMaps).addTo(mapRef.current);

                if (allPoints.length > 0) {
                    mapRef.current.fitBounds(allPoints, { padding: [50, 50] });
                }

                // Invalidate size to ensure map renders correctly in modal
                setTimeout(() => {
                    if(mapRef.current) {
                      mapRef.current.invalidateSize();
                    }
                }, 400);

                return () => {
                  if (mapRef.current) {
                    mapRef.current.remove();
                    mapRef.current = null;
                  }
                };
            }, [currentProject]);

            return (
                <Modal show={true} onClose={onClose} title="Mappa del Progetto" className="w-full sm:max-w-6xl">
                    <div id="map-container" style={{ height: '70vh', width: '100%', borderRadius: '8px' }}>
                        {/* Map will be rendered here */}
                    </div>
                </Modal>
            );
        };

        const ProjectSelector = () => {
          const { projects, selectProject, createProject, updateProject, deleteProject, importProject } = React.useContext(AppContext);
          const [showNewProjectModal, setShowNewProjectModal] = React.useState(false);
          const [showEditProjectModal, setShowEditProjectModal] = React.useState(false);
          const [selectedProjectToEdit, setSelectedProjectToEdit] = React.useState(null);
          const [showConfirmDeleteProject, setShowConfirmDeleteProject] = React.useState(false);
          const [projectToDelete, setProjectToDelete] = React.useState(null);
          const [showAuthorModal, setShowAuthorModal] = React.useState(false);
          const fileInputRef = React.useRef(null);

          const handleCreateNewProject = (data) => {
            createProject(data);
            setShowNewProjectModal(false);
          };

          const handleEditProjectSave = (updatedData) => {
              updateProject(selectedProjectToEdit.id, updatedData);
              setShowEditProjectModal(false);
              setSelectedProjectToEdit(null);
              alert('Progetto modificato con successo!');
          };

          const handleDeleteProjectClick = (project) => {
              setProjectToDelete(project);
              setShowConfirmDeleteProject(true);
          };

          const confirmDeleteProject = () => {
              deleteProject(projectToDelete.id);
              setShowConfirmDeleteProject(false);
              setProjectToDelete(null);
          };
          
          const handleImportClick = () => {
              fileInputRef.current.click();
          };

          const handleFileSelected = (event) => {
              const file = event.target.files[0];
              if (!file) return;

              const reader = new FileReader();
              reader.onload = (e) => {
                  try {
                      const projectData = JSON.parse(e.target.result);
                      if (projectData.id && projectData.customProjectId && projectData.name) {
                          importProject(projectData);
                      } else {
                          alert('File non valido. Assicurati che sia un file di progetto USManager esportato correttamente.');
                      }
                  } catch (error) {
                      console.error("Errore durante l'importazione del progetto:", error);
                      alert('Errore nel parsing del file di progetto. Il file potrebbe essere corrotto o non nel formato corretto.');
                  }
              };
              reader.readAsText(file);
              event.target.value = null; 
          };

          return (
            <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
              <div className="bg-white p-8 rounded-xl shadow-2xl w-full sm:max-w-2xl">
                <h1 className="text-4xl font-bold text-center text-slate-800 mb-2">USManager</h1>
                <p className="text-center text-slate-500 mb-8">Un Web-GIS per la gestione dei dati di scavo</p>
                <h2 className="text-2xl font-semibold text-slate-700 mb-6">Seleziona un Progetto</h2>

                {projects.length === 0 ? (
                  <div className="text-center bg-slate-50 p-6 rounded-lg border-2 border-dashed border-slate-300">
                    <p className="text-slate-500 mb-4">Nessun progetto esistente. Creane uno nuovo o importa un progetto per iniziare!</p>
                  </div>
                ) : (
                  <div className="space-y-4 mb-6">
                    {projects.map((project) => (
                        <div key={project.id} className="group flex flex-col sm:flex-row items-center justify-between bg-white border border-slate-200 rounded-lg p-4 shadow-sm hover:shadow-lg hover:border-blue-500 transition-all duration-300">
                          <button
                            onClick={() => selectProject(project.id)}
                            className="flex-grow text-left w-full"
                          >
                            <span className="block text-lg font-semibold text-blue-700 group-hover:text-blue-800">{project.name}</span>
                            <span className="block text-sm text-slate-500">Codice: {project.customProjectId}</span>
                          </button>
                          <div className="flex gap-2 mt-3 sm:mt-0 sm:ml-4 self-end sm:self-center">
                            <button
                              onClick={(e) => { e.stopPropagation(); setShowEditProjectModal(true); setSelectedProjectToEdit(project); }}
                              className="bg-yellow-400 text-white p-2 rounded-lg hover:bg-yellow-500 transition duration-200 shadow-sm text-sm"
                              title="Modifica Progetto"
                            >
                              ‚úèÔ∏è
                            </button>
                            <button
                              onClick={(e) => { e.stopPropagation(); handleDeleteProjectClick(project); }}
                              className="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-200 shadow-sm text-sm"
                              title="Elimina Progetto"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </div>
                      )
                    )}
                  </div>
                )}
                
                <div className="flex flex-col sm:flex-row gap-4">
                    <button
                      onClick={() => setShowNewProjectModal(true)}
                      className="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md text-lg font-semibold active:scale-95 flex items-center justify-center gap-2"
                    >
                      <span className="text-2xl">‚ûï</span> Crea Nuovo Progetto
                    </button>
                    <button
                      onClick={handleImportClick}
                      className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md text-lg font-semibold active:scale-95 flex items-center justify-center gap-2"
                    >
                      <span className="text-2xl">üì•</span> Importa Progetto
                    </button>
                    <input type="file" ref={fileInputRef} onChange={handleFileSelected} accept=".json" style={{ display: 'none' }} />
                </div>

                <div className="text-center mt-6">
                    <button
                        onClick={() => setShowAuthorModal(true)}
                        className="text-sm text-slate-500 hover:text-slate-700 hover:underline"
                    >
                        Informazioni Autore
                    </button>
                </div>
              </div>

              {showNewProjectModal && (
                <ProjectDialog show={showNewProjectModal} onClose={() => setShowNewProjectModal(false)} onSave={handleCreateNewProject} />
              )}
              {showEditProjectModal && selectedProjectToEdit && (
                  <ProjectDialog
                      show={showEditProjectModal}
                      onClose={() => setShowEditProjectModal(false)}
                      onSave={(data) => updateProject(selectedProjectToEdit.id, data)}
                      projectData={selectedProjectToEdit}
                  />
              )}
              <Modal show={showAuthorModal} onClose={() => setShowAuthorModal(false)} title="Autore Applicazione">
                <div className="text-center p-4">
                    <p className="text-lg font-semibold text-slate-800">Curto, Mattia</p>
                </div>
              </Modal>
              {projectToDelete && <ConfirmDialog
                show={showConfirmDeleteProject}
                message={`ATTENZIONE: Sei sicuro di voler eliminare il progetto "${projectToDelete.name}" e TUTTI i suoi dati? Questa azione √® irreversibile.`}
                onConfirm={confirmDeleteProject}
                onCancel={() => setShowConfirmDeleteProject(false)}
              />}
            </div>
          );
        };

        const USManagerMainApp = () => {
          const { currentProject, deleteUSCard, setCurrentProjectId, deleteProject, exportProject, updateProject } = React.useContext(AppContext);
          const [showUSCardModal, setShowUSCardModal] = React.useState(false);
          const [showCustomFieldsModal, setShowCustomFieldsModal] = React.useState(false);
          const [showDiaryViewerModal, setShowDiaryViewerModal] = React.useState(false);
          const [showFindsManagerModal, setShowFindsManagerModal] = React.useState(false);
          const [showSampleManagerModal, setShowSampleManagerModal] = React.useState(false); // NUOVO STATO
          const [showReportsModal, setShowReportsModal] = React.useState(false);
          const [showHarrisMatrixModal, setShowHarrisMatrixModal] = React.useState(false);
          const [showMapModal, setShowMapModal] = React.useState(false);

          const [selectedUSCard, setSelectedUSCard] = React.useState(null);
          const [isUSCardViewer, setIsUSCardViewer] = React.useState(false);
          const [searchQuery, setSearchQuery] = React.useState('');

          const [showConfirmDeleteUS, setShowConfirmDeleteUS] = React.useState(false);
          const [usCardToDelete, setUsCardToDelete] = React.useState(null);
          const [showConfirmDeleteProjectMain, setShowConfirmDeleteProjectMain] = React.useState(false);

          const usFindsCount = React.useMemo(() => {
              const counts = {};
              for (const findId in currentProject.findsEntries || {}) {
                  const findData = currentProject.findsEntries[findId];
                  if (findData.us) {
                      const usName = findData.us;
                      const numItems = parseInt(findData.nrReperti, 10) || 1;
                      counts[usName] = (counts[usName] || 0) + numItems;
                  }
              }
              return counts;
          }, [currentProject.findsEntries]);

          const usInDiaryNumbers = React.useMemo(() => {
              const numbers = new Set();
              for (const diaryId in currentProject.diaryEntries || {}) {
                  const diaryData = currentProject.diaryEntries[diaryId];
                  const suIndagateStr = diaryData.suIndagate || '';
                  suIndagateStr.split(',').forEach(suEntry => {
                      const suNumMatch = suEntry.trim().match(/\d+/);
                      if (suNumMatch) {
                          numbers.add(parseInt(suNumMatch[0], 10));
                      }
                  });
              }
              return numbers;
          }, [currentProject.diaryEntries]);

          const filteredUSCards = Object.values(currentProject.usCards || {}).filter(card => {
            if (!searchQuery) return true;
            const searchLower = searchQuery.toLowerCase();
            const description = card.description?.toLowerCase() || '';
            const observations = card.observations?.toLowerCase() || '';
            const interpretations = card.interpretations?.toLowerCase() || '';
            return description.includes(searchLower) || observations.includes(searchLower) || interpretations.includes(searchLower);
          }).sort((a, b) => a.usNumber - b.usNumber);

          const openNewUSCard = () => {
            setSelectedUSCard(null);
            setIsUSCardViewer(false);
            setShowUSCardModal(true);
          };

          const editSelectedUSCard = (usCard) => {
            setSelectedUSCard(usCard);
            setIsUSCardViewer(false);
            setShowUSCardModal(true);
          };

          const viewSelectedUSCard = (usCard) => {
            setSelectedUSCard(usCard);
            setIsUSCardViewer(true);
            setShowUSCardModal(true);
          };

          const handleDeleteUSCardClick = (usId) => {
            setUsCardToDelete(usId);
            setShowConfirmDeleteUS(true);
          };

          const confirmDeleteUSCard = () => {
            deleteUSCard(usCardToDelete);
            setShowConfirmDeleteUS(false);
            setUsCardToDelete(null);
          };

          const handleDeleteProjectClick = () => {
            setShowConfirmDeleteProjectMain(true);
          };

          const confirmDeleteProjectMain = () => {
            deleteProject(currentProject.id);
          };

          const handleExportUSCards = () => {
              exportToCsv('schede_us.csv', Object.values(currentProject.usCards || {}));
          };
          
          const DashboardButton = ({ onClick, children, className }) => (
            <button
              onClick={onClick}
              className={`flex flex-col items-center justify-center text-center p-4 bg-white rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-300 ${className}`}
            >
              {children}
            </button>
          );

          return (
            <div className="min-h-screen bg-slate-100 p-4 sm:p-8 font-inter">
              <div className="bg-white rounded-xl shadow-2xl p-6 sm:p-8">
                <div className="flex flex-col sm:flex-row justify-between items-start mb-8 border-b border-slate-200 pb-6">
                  <div className="mb-4 sm:mb-0 text-center sm:text-left">
                    <h1 className="text-3xl sm:text-4xl font-extrabold text-slate-800">{currentProject.name}</h1>
                    <p className="text-lg text-slate-500">Codice Progetto: <span className="font-semibold">{currentProject.customProjectId}</span></p>
                    <p className="text-xs text-slate-400 mt-1">ID Interno: {currentProject.id}</p>
                  </div>
                  <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <button
                      onClick={() => setCurrentProjectId(null)}
                      className="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition duration-200 shadow-sm w-full"
                    >
                      Cambia Progetto
                    </button>
                    <button
                      onClick={() => exportProject()}
                      className="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition duration-200 shadow-sm w-full flex items-center justify-center gap-2"
                    >
                      <span>üì§</span> Esporta Progetto
                    </button>
                    <button
                      onClick={handleDeleteProjectClick}
                      className="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200 shadow-sm w-full flex items-center justify-center gap-2"
                    >
                      <span>üóëÔ∏è</span> Elimina
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-12 gap-6 mb-8">
                    <div className="md:col-span-4 p-6 bg-blue-50 rounded-lg shadow-inner">
                        <h3 className="text-xl font-bold text-blue-900 mb-4">Azioni Rapide</h3>
                        <div className="flex flex-col gap-3">
                            <button
                              onClick={openNewUSCard}
                              className="w-full text-left bg-blue-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-700 transition-transform duration-200 shadow-lg active:scale-95 flex items-center gap-3 text-lg"
                            >
                              <span className="text-2xl">‚ûï</span> Nuova Scheda US
                            </button>
                            <button
                              onClick={handleExportUSCards}
                              className="w-full text-left bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-transform duration-200 shadow-md active:scale-95 flex items-center gap-2"
                            >
                              <span className="text-xl">üìÑ</span> Esporta Schede US (CSV)
                            </button>
                        </div>
                    </div>
                    <div className="md:col-span-8 p-6 bg-slate-50 rounded-lg shadow-inner">
                        <h3 className="text-xl font-bold text-slate-800 mb-4">Strumenti</h3>
                        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <DashboardButton onClick={() => setShowMapModal(true)}>
                                <span className="text-4xl mb-2">üó∫Ô∏è</span>
                                <span className="font-semibold text-slate-700">Visualizza Mappa</span>
                            </DashboardButton>
                            <DashboardButton onClick={() => setShowHarrisMatrixModal(true)}>
                                <span className="text-4xl mb-2">üìà</span>
                                <span className="font-semibold text-slate-700">Matrix di Harris</span>
                            </DashboardButton>
                             <DashboardButton onClick={() => setShowDiaryViewerModal(true)}>
                                <span className="text-4xl mb-2">üìì</span>
                                <span className="font-semibold text-slate-700">Gestione Diario</span>
                            </DashboardButton>
                             <DashboardButton onClick={() => setShowFindsManagerModal(true)}>
                                <span className="text-4xl mb-2">üè∫</span>
                                <span className="font-semibold text-slate-700">Gestione Reperti</span>
                            </DashboardButton>
                            {/* NUOVO PULSANTE GESTIONE CAMPIONI */}
                            <DashboardButton onClick={() => setShowSampleManagerModal(true)}>
                                <span className="text-4xl mb-2">üß™</span>
                                <span className="font-semibold text-slate-700">Gestione Campioni</span>
                            </DashboardButton>
                            <DashboardButton onClick={() => setShowCustomFieldsModal(true)}>
                                <span className="text-4xl mb-2">‚öôÔ∏è</span>
                                <span className="font-semibold text-slate-700">Campi Personalizzati</span>
                            </DashboardButton>
                            <DashboardButton onClick={() => setShowReportsModal(true)}>
                                <span className="text-4xl mb-2">üìä</span>
                                <span className="font-semibold text-slate-700">Genera Report</span>
                            </DashboardButton>
                        </div>
                    </div>
                </div>


                <h2 className="text-2xl font-bold text-slate-800 mb-4">Schede US Esistenti</h2>

                <div className="mb-6">
                  <input
                    type="text"
                    placeholder="Cerca in Descrizione, Osservazioni, Interpretazioni..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition shadow-sm"
                  />
                </div>

                <div className="hidden sm:block overflow-x-auto rounded-lg shadow-md border border-slate-200">
                  <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">SU</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Nr. Reperti</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Autore</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Data</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Completezza</th>
                        <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">Nel diario</th>
                        <th className="px-6 py-3 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">Azioni</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                      {filteredUSCards.length === 0 ? (
                        <tr>
                          <td colSpan="7" className="px-6 py-4 text-center text-slate-500">Nessuna scheda US trovata.</td>
                        </tr>
                      ) : (
                        filteredUSCards.map(card => {
                          const desc = card.description?.trim() || '';
                          const obs = card.observations?.trim() || '';
                          const interp = card.interpretations?.trim() || '';
                          const simp = card.simplifiedRelations || {};
                          const isComplete = (simp['Copre']?.trim() || simp['Coperto da']?.trim()) && desc && obs && interp;
                          const isUSInDiary = usInDiaryNumbers.has(card.usNumber);
                          const rowClass = isComplete ? 'bg-green-50' : 'bg-red-50';

                          return (
                            <tr key={card.id} className={`${rowClass} hover:bg-slate-100 transition-colors`}>
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">US{card.usNumber}</td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{usFindsCount[`US${card.usNumber}`] || 0}</td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{card.reportAuthor}</td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{card.date}</td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm">
                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isComplete ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                  {isComplete ? 'Completa' : 'Incompleta'}
                                </span>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-800">{isUSInDiary ? 'S√¨' : 'No'}</td>
                              <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div className="flex gap-2 justify-end">
                                  <button onClick={() => viewSelectedUSCard(card)} className="text-blue-600 hover:text-blue-900 text-xl" title="Visualizza">üëÅÔ∏è</button>
                                  <button onClick={() => editSelectedUSCard(card)} className="text-indigo-600 hover:text-indigo-900 text-xl" title="Modifica">‚úèÔ∏è</button>
                                  <button onClick={() => handleDeleteUSCardClick(card.id)} className="text-red-600 hover:text-red-900 text-xl" title="Elimina">üóëÔ∏è</button>
                                </div>
                              </td>
                            </tr>
                          );
                        })
                      )}
                    </tbody>
                  </table>
                </div>

                <div className="block sm:hidden space-y-4 mt-4">
                    {filteredUSCards.length === 0 ? (
                        <p className="text-center text-slate-500 py-4">Nessuna scheda US trovata.</p>
                    ) : (
                        filteredUSCards.map(card => {
                            const desc = card.description?.trim() || '';
                            const obs = card.observations?.trim() || '';
                            const interp = card.interpretations?.trim() || '';
                            const simp = card.simplifiedRelations || {};
                            const isComplete = (simp['Copre']?.trim() || simp['Coperto da']?.trim()) && desc && obs && interp;
                            const isUSInDiary = usInDiaryNumbers.has(card.usNumber);

                            return (
                                <div key={card.id} className={`bg-white rounded-lg shadow-md p-4 border-l-4 ${isComplete ? 'border-green-500' : 'border-red-500'}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="text-lg font-bold text-slate-900">US{card.usNumber}</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => viewSelectedUSCard(card)} className="text-blue-600 hover:text-blue-900 p-1 text-2xl" title="Visualizza">üëÅÔ∏è</button>
                                            <button onClick={() => editSelectedUSCard(card)} className="text-indigo-600 hover:text-indigo-900 p-1 text-2xl" title="Modifica">‚úèÔ∏è</button>
                                            <button onClick={() => handleDeleteUSCardClick(card.id)} className="text-red-600 hover:text-red-900 p-1 text-2xl" title="Elimina">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <p className="text-sm text-slate-700 mb-1"><strong>Nr. Reperti:</strong> {usFindsCount[`US${card.usNumber}`] || 0}</p>
                                    <p className="text-sm text-slate-700 mb-1"><strong>Autore:</strong> {card.reportAuthor}</p>
                                    <p className="text-sm text-slate-700 mb-1"><strong>Data:</strong> {card.date}</p>
                                    <p className="text-sm text-slate-700 mb-1"><strong>Completezza:</strong>
                                       <span className={`ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isComplete ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                          {isComplete ? 'Completa' : 'Incompleta'}
                                       </span>
                                    </p>
                                    <p className="text-sm text-slate-700"><strong>Nel diario:</strong> {isUSInDiary ? 'S√¨' : 'No'}</p>
                                </div>
                            );
                        })
                    )}
                </div>
              </div>

              {showUSCardModal && (
                <USCardDialog show={showUSCardModal} onClose={() => setShowUSCardModal(false)} usCard={selectedUSCard} isViewer={isUSCardViewer} />
              )}
              {showCustomFieldsModal && (
                <CustomFieldsDialog show={showCustomFieldsModal} onClose={() => setShowCustomFieldsModal(false)} />
              )}
              {showDiaryViewerModal && (
                <DiaryViewerDialog show={showDiaryViewerModal} onClose={() => setShowDiaryViewerModal(false)} />
              )}
              {showFindsManagerModal && (
                <FindsManagerDialog show={showFindsManagerModal} onClose={() => setShowFindsManagerModal(false)} />
              )}
              {/* NUOVO: Render del Dialog Gestione Campioni */}
              {showSampleManagerModal && (
                <SampleManagerDialog show={showSampleManagerModal} onClose={() => setShowSampleManagerModal(false)} />
              )}
              {showReportsModal && (
                <ReportsDialog show={showReportsModal} onClose={() => setShowReportsModal(false)} />
              )}
              {showHarrisMatrixModal && (
                <HarrisMatrixDialog show={showHarrisMatrixModal} onClose={() => setShowHarrisMatrixModal(false)} />
              )}
              {showMapModal && (
                <MapViewDialog show={showMapModal} onClose={() => setShowMapModal(false)} />
              )}
              <ConfirmDialog
                show={showConfirmDeleteUS}
                message={`Sei sicuro di voler eliminare la scheda US${usCardToDelete ? currentProject.usCards[usCardToDelete]?.usNumber : ''}?`}
                onConfirm={confirmDeleteUSCard}
                onCancel={() => setShowConfirmDeleteUS(false)}
              />
              <ConfirmDialog
                show={showConfirmDeleteProjectMain}
                message={`ATTENZIONE: Sei sicuro di voler eliminare il progetto "${currentProject?.name}" (Codice: ${currentProject?.customProjectId}) e TUTTI i suoi dati? Questa azione √® irreversibile.`}
                onConfirm={confirmDeleteProjectMain}
                onCancel={() => setShowConfirmDeleteProjectMain(false)}
              />
            </div>
          );
        };
        
        // --- FINE BLOCCO COMPONENTI REACT ---

        // AppProvider gestisce lo stato e le interazioni col DB
        const AppProvider = ({ children }) => {
            const [projects, setProjects] = React.useState([]);
            const [currentProject, setCurrentProject] = React.useState(null);
            const [currentProjectId, setCurrentProjectId] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);

            // Carica la lista dei progetti all'avvio
            React.useEffect(() => {
                const loadInitialProjects = async () => {
                    setIsLoading(true);
                    const allProjects = await db.projects.toArray();
                    setProjects(allProjects.map(p => ({id: p.id, name: p.name, customProjectId: p.customProjectId})));
                    setIsLoading(false);
                };
                loadInitialProjects();
            }, []);

            // Carica i dati completi del progetto quando viene selezionato
            React.useEffect(() => {
                const loadFullProjectData = async () => {
                    if (!currentProjectId) {
                        setCurrentProject(null);
                        return;
                    }
                    setIsLoading(true);
                    const projectData = await db.projects.get(currentProjectId);
                    if (projectData) {
                        // MODIFICATO: Aggiunto caricamento campioni
                        const [usCards, diaryEntries, findsEntries, samples] = await Promise.all([
                            db.usCards.where('projectId').equals(currentProjectId).toArray(),
                            db.diaryEntries.where('projectId').equals(currentProjectId).toArray(),
                            db.findsEntries.where('projectId').equals(currentProjectId).toArray(),
                            db.samples.where('projectId').equals(currentProjectId).toArray()
                        ]);
                        
                        const usCardsObj = usCards.reduce((acc, card) => ({ ...acc, [card.id]: card }), {});
                        const diaryEntriesObj = diaryEntries.reduce((acc, entry) => ({ ...acc, [entry.id]: entry }), {});
                        const findsEntriesObj = findsEntries.reduce((acc, entry) => ({ ...acc, [entry.id]: entry }), {});
                        const samplesObj = samples.reduce((acc, sample) => ({ ...acc, [sample.id]: sample }), {});

                        setCurrentProject({ ...projectData, usCards: usCardsObj, diaryEntries: diaryEntriesObj, findsEntries: findsEntriesObj, samples: samplesObj });
                    }
                    setIsLoading(false);
                };
                loadFullProjectData();
            }, [currentProjectId]);

            const selectProject = (projectId) => setCurrentProjectId(projectId);

            const createProject = async (projectData) => {
                const existingProject = await db.projects.where('customProjectId').equals(projectData.customProjectId).first();
                if (existingProject) {
                    alert(`Un progetto con il codice "${projectData.customProjectId}" esiste gi√†.`);
                    return;
                }
                const newProject = { ...projectData, id: generateUniqueId(), customFields: [], harrisLayout: {} };
                await db.projects.put(newProject);
                setProjects(prev => [...prev, {id: newProject.id, name: newProject.name, customProjectId: newProject.customProjectId}]);
                selectProject(newProject.id);
            };

            const updateProject = async (projectIdToUpdate, updatedData) => {
                await db.projects.update(projectIdToUpdate, updatedData);
                setProjects(prev => prev.map(p => p.id === projectIdToUpdate ? { ...p, ...updatedData } : p));
                if(currentProjectId === projectIdToUpdate) {
                  setCurrentProject(prev => ({ ...prev, ...updatedData }));
                }
            };

            const deleteProject = async (projectIdToDelete) => {
              try {
                // MODIFICATO: Aggiunta tabella samples alla transazione
                await db.transaction('rw', db.projects, db.usCards, db.diaryEntries, db.findsEntries, db.samples, async () => {
                    await db.projects.delete(projectIdToDelete);
                    await db.usCards.where('projectId').equals(projectIdToDelete).delete();
                    await db.diaryEntries.where('projectId').equals(projectIdToDelete).delete();
                    await db.findsEntries.where('projectId').equals(projectIdToDelete).delete();
                    await db.samples.where('projectId').equals(projectIdToDelete).delete();
                });
                setProjects(prev => prev.filter(p => p.id !== projectIdToDelete));
                if (currentProjectId === projectIdToDelete) {
                    setCurrentProjectId(null);
                }
                alert('Progetto eliminato con successo.');
              } catch (error) {
                console.error("Errore durante l'eliminazione del progetto:", error);
                alert("Si √® verificato un errore durante l'eliminazione.");
              }
            };
            
            const exportProject = async () => {
              if (!currentProject) {
                  alert('Nessun progetto selezionato da esportare.');
                  return;
              }
              const projectJson = JSON.stringify(currentProject, null, 2);
              const blob = new Blob([projectJson], { type: 'application/json' });
              const link = document.createElement('a');
              link.href = URL.createObjectURL(blob);
              link.download = `USM_Project_${currentProject.name.replace(/ /g, '_')}.json`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(link.href);
            };

            const importProject = async (projectData) => {
                const existing = await db.projects.where('customProjectId').equals(projectData.customProjectId).first();
                if (existing) {
                    if (!confirm(`Un progetto con il codice "${projectData.customProjectId}" esiste gi√†. Vuoi sovrascriverlo? L'operazione √® irreversibile.`)) return;
                    await deleteProject(existing.id); 
                }
                
                try {
                  // MODIFICATO: Aggiunta gestione samples
                  const { usCards, diaryEntries, findsEntries, samples, ...projectMeta } = projectData;
                  const projectId = projectMeta.id;

                  await db.transaction('rw', db.projects, db.usCards, db.diaryEntries, db.findsEntries, db.samples, async () => {
                      await db.projects.put(projectMeta);
                      if (usCards) await db.usCards.bulkPut(Object.values(usCards).map(c => ({...c, projectId })));
                      if (diaryEntries) await db.diaryEntries.bulkPut(Object.values(diaryEntries).map(e => ({...e, projectId })));
                      if (findsEntries) await db.findsEntries.bulkPut(Object.values(findsEntries).map(f => ({...f, projectId })));
                      if (samples) await db.samples.bulkPut(Object.values(samples).map(s => ({...s, projectId })));
                  });
                  const allProjects = await db.projects.toArray();
                  setProjects(allProjects.map(p => ({id: p.id, name: p.name, customProjectId: p.customProjectId})));
                  alert('Progetto importato con successo.');
                } catch(error) {
                  console.error("Errore durante l'importazione del progetto:", error);
                  alert("Si √® verificato un errore durante l'importazione.");
                }
            };
            
            // --- Funzioni CRUD per i dati del progetto ---
            
            const updateUSCard = async (cardData) => {
                const dataToSave = { ...cardData, projectId: currentProjectId };
                await db.usCards.put(dataToSave);
                setCurrentProject(prev => ({ ...prev, usCards: { ...prev.usCards, [dataToSave.id]: dataToSave } }));
            };

            const deleteUSCard = async (cardId) => {
                await db.usCards.delete(cardId);
                setCurrentProject(prev => { const newCards = { ...prev.usCards }; delete newCards[cardId]; return { ...prev, usCards: newCards }; });
            };

            const updateDiaryEntry = async (entryData) => {
              const dataToSave = { ...entryData, projectId: currentProjectId };
              await db.diaryEntries.put(dataToSave);
              setCurrentProject(prev => ({ ...prev, diaryEntries: { ...prev.diaryEntries, [dataToSave.id]: dataToSave } }));
            };

            const deleteDiaryEntry = async (entryId) => {
                await db.diaryEntries.delete(entryId);
                setCurrentProject(prev => { const newEntries = { ...prev.diaryEntries }; delete newEntries[entryId]; return { ...prev, diaryEntries: newEntries }; });
            };

            const updateFindEntry = async (entryData) => {
              const dataToSave = { ...entryData, projectId: currentProjectId };
              await db.findsEntries.put(dataToSave);
              setCurrentProject(prev => ({ ...prev, findsEntries: { ...prev.findsEntries, [dataToSave.id]: dataToSave } }));
            };

            const deleteFindEntry = async (entryId) => {
                await db.findsEntries.delete(entryId);
                setCurrentProject(prev => { const newEntries = { ...prev.findsEntries }; delete newEntries[entryId]; return { ...prev, findsEntries: newEntries }; });
            };
            
            // NUOVE FUNZIONI CRUD PER I CAMPIONI
            const updateSample = async (sampleData) => {
              const dataToSave = { ...sampleData, projectId: currentProjectId };
              await db.samples.put(dataToSave);
              setCurrentProject(prev => ({ ...prev, samples: { ...prev.samples, [dataToSave.id]: dataToSave } }));
            };

            const deleteSample = async (sampleId) => {
                await db.samples.delete(sampleId);
                setCurrentProject(prev => { const newSamples = { ...prev.samples }; delete newSamples[sampleId]; return { ...prev, samples: newSamples }; });
            };

            const updateCustomFields = async (fields) => {
                await db.projects.update(currentProjectId, { customFields: fields });
                setCurrentProject(prev => ({ ...prev, customFields: fields }));
            };

            const updateHarrisLayout = async (layout) => {
                await db.projects.update(currentProjectId, { harrisLayout: layout });
                setCurrentProject(prev => ({ ...prev, harrisLayout: layout }));
            };
            
            const updateUSRelationsAutomatically = async (currentUSNumber, relationKey, oldRelationsStr, newRelationsStr) => {
              const currentUSName = `US${currentUSNumber}`;
              const reciprocalKey = relationKey === 'Copre' ? 'Coperto da' : 'Copre';
              const oldRelatedUS = new Set(oldRelationsStr.split(',').map(s => s.trim()).filter(s => s.startsWith('US')));
              const newRelatedUS = new Set(newRelationsStr.split(',').map(s => s.trim()).filter(s => s.startsWith('US')));
              const addedUS = [...newRelatedUS].filter(us => !oldRelatedUS.has(us));
              const removedUS = [...oldRelatedUS].filter(us => !newRelatedUS.has(us));

              for (const usName of addedUS) {
                  const targetCard = Object.values(currentProject.usCards).find(c => `US${c.usNumber}` === usName);
                  if (targetCard) {
                      const currentTargetRelations = new Set((targetCard.simplifiedRelations?.[reciprocalKey] || '').split(',').map(s => s.trim()).filter(Boolean));
                      currentTargetRelations.add(currentUSName);
                      targetCard.simplifiedRelations[reciprocalKey] = Array.from(currentTargetRelations).sort().join(', ');
                      await updateUSCard(targetCard);
                  }
              }

              for (const usName of removedUS) {
                  const targetCard = Object.values(currentProject.usCards).find(c => `US${c.usNumber}` === usName);
                  if (targetCard) {
                      const currentTargetRelations = new Set((targetCard.simplifiedRelations?.[reciprocalKey] || '').split(',').map(s => s.trim()).filter(Boolean));
                      currentTargetRelations.delete(currentUSName);
                      targetCard.simplifiedRelations[reciprocalKey] = Array.from(currentTargetRelations).sort().join(', ');
                      await updateUSCard(targetCard);
                  }
              }
            };


            const contextValue = {
              projects, currentProject, selectProject, createProject, updateProject, deleteProject, 
              updateUSCard, deleteUSCard, 
              updateDiaryEntry, deleteDiaryEntry, 
              updateFindEntry, deleteFindEntry, 
              updateSample, deleteSample, // Aggiunto al contesto
              updateCustomFields, updateHarrisLayout, updateUSRelationsAutomatically, setCurrentProjectId, 
              importProject, exportProject,
            };

            if (isLoading && !currentProject) {
              return <div className="min-h-screen flex items-center justify-center"><p className="text-xl font-semibold">Caricamento Database...</p></div>;
            }

            return (
              <AppContext.Provider value={contextValue}>
                 {currentProjectId && !currentProject ? 
                    <div className="min-h-screen flex items-center justify-center"><p className="text-xl font-semibold">Caricamento Progetto...</p></div> :
                    (currentProject ? <USManagerMainApp /> : <ProjectSelector />)
                 }
              </AppContext.Provider>
            );
        };

        const App = () => <AppProvider />;
        ReactDOM.render(<App />, document.getElementById('root'));
        console.log('React App render call completed.');
    </script>
</body>
</html>